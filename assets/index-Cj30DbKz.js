(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class ie{_subs=new Set;subscribe(e){return this._subs.add(e),()=>this._subs.delete(e)}publish(e){for(const t of this._subs)t(e)}clear(){this._subs.clear()}}class se{_subs=new Set;subscribe(e){return this._subs.add(e),()=>this._subs.delete(e)}publish(e){for(const t of this._subs)t(e)}clear(){this._subs.clear()}}var p=(r=>(r.Hz25="25Hz",r.Hz10="10Hz",r.Hz5="5Hz",r.Hz1="1Hz",r))(p||{});const ne={"25Hz":1e3/25,"10Hz":1e3/10,"5Hz":1e3/5,"1Hz":1e3/1};class re{_subs=new Map;_timers=new Map;_active=!0;constructor(){for(const e of Object.values(p))this._subs.set(e,new Set);this._active=!document.hidden,this._toggleTimers(this._active),document.addEventListener("visibilitychange",()=>{this._active=!document.hidden,this._toggleTimers(this._active)})}subscribe(e,t){const i=this._subs.get(e);if(!i)throw new Error(`Unknown scheduler rate: ${e}`);return i.add(t),this._active&&this._ensureTimer(e),()=>{i.delete(t),i.size===0&&this._clearTimer(e)}}_ensureTimer(e){if(this._timers.has(e))return;const t=window.setInterval(()=>{const i=this._subs.get(e);if(!(!i||i.size===0))for(const s of i)s()},ne[e]);this._timers.set(e,t)}_clearTimer(e){const t=this._timers.get(e);t&&(clearInterval(t),this._timers.delete(e))}_toggleTimers(e){if(!e){for(const t of this._timers.values())clearInterval(t);this._timers.clear();return}for(const[t,i]of this._subs.entries())i.size!==0&&this._ensureTimer(t)}}const v="0",ae=[{vendorId:1155,productId:22288,profileCode:"22288"}];function F(r){if(r==null)return v;const e=String(r).trim();return e.length>0?e:v}function oe(r){if(!r)return v;for(const e of ae)if(!(typeof e.vendorId=="number"&&r.vendorId!==e.vendorId)&&!(typeof e.productId=="number"&&r.productId!==e.productId)&&!(typeof e.productNameIncludes=="string"&&!(r.productName??"").toLowerCase().includes(e.productNameIncludes.toLowerCase())))return F(e.profileCode);return F(r.productId)}class ce{subscribers=new Set;currentProfileCode=v;subscribe(e){return this.subscribers.add(e),e(this.currentProfileCode),()=>this.subscribers.delete(e)}publish(e){this.currentProfileCode=F(e);for(const t of this.subscribers)t(this.currentProfileCode)}clear(){this.publish(v)}}class le{constructor(e){if(!e?.bus||typeof e.bus.publish!="function")throw new Error("HIDClient requires a bus with a publish(report) method.");this.bus=e.bus,this.commandBus=e.commandBus,this.filters=e.filters??[{vendorId:1155,productId:22288}],this.deviceProfileBus=e.deviceProfileBus,this.device=null,this.statusListeners=new Set,this._boundOnInputReport=this._onInputReport.bind(this),this._boundOnDisconnect=this._onDisconnect.bind(this),this._boundOnCommand=this._onCommand.bind(this),this.commandBus&&(this._commandUnsubscribe=this.commandBus.subscribe(this._boundOnCommand))}bus;commandBus;deviceProfileBus;_commandUnsubscribe;filters;device;statusListeners;_boundOnInputReport;_boundOnDisconnect;_boundOnCommand;isSupported(){return"hid"in navigator}isConnected(){return!!this.device&&this.device.opened}onStatus(e){return this.statusListeners.add(e),e(this.isConnected()?"Connected":"Disconnected"),()=>this.statusListeners.delete(e)}_emitStatus(e){for(const t of this.statusListeners)t(e)}async connect(){if(!this.isSupported())throw new Error("WebHID is not supported in this browser.");this.device&&await this.disconnect(),this._emitStatus("Opening device chooser...");const e=await navigator.hid.requestDevice({filters:this.filters});if(!e||e.length===0){this._emitStatus("No device selected.");return}this.device=e[0],await this.device.open(),this.device.addEventListener("inputreport",this._boundOnInputReport),navigator.hid.addEventListener("disconnect",this._boundOnDisconnect),this.deviceProfileBus?.publish(oe(this.device)),this._emitStatus(`Connected: ${this.device.productName||"HID device"}`)}async disconnect(){if(!this.device){this.deviceProfileBus?.publish(v),this._emitStatus("Disconnected");return}try{this.device.removeEventListener("inputreport",this._boundOnInputReport),navigator.hid.removeEventListener("disconnect",this._boundOnDisconnect),this.device.opened&&await this.device.close()}finally{this.device=null,this.deviceProfileBus?.publish(v),this._emitStatus("Disconnected")}}_onDisconnect(e){this.device&&e.device===this.device&&this.disconnect().catch(()=>{})}async _onCommand(e){if(!this.device||!this.device.opened)return;const t=e.type==="hid_send"&&e.bytes instanceof Uint8Array,i=t?0:e.reportId,s=t?e.bytes:e.data;if(typeof i!="number"||!s){this._emitStatus("Send failed: invalid command payload.");return}try{await this.device.sendReport(i,s)}catch(n){this._emitStatus(`Send failed: ${n instanceof Error?n.message:String(n)}`)}}_onInputReport(e){const t=e.data,i=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s=new Uint8Array(64);s.set(i.subarray(0,64));const n=new DataView(s.buffer),a=[n.getUint8(0),n.getUint8(1),n.getUint8(2),n.getUint8(3)],o=[],c=[];for(let l=0;l<15;l+=1){const u=4+l*4;o.push(n.getFloat32(u,!0)),c.push(n.getInt32(u,!0))}this.bus.publish({reportId:e.reportId,timestampMs:performance.now(),device:this.device,CommandBytes:a,floatValues:o,intValues:c,byteLength:s.length,rawBytes:s})}}class ue{constructor(e){if(!e?.bus||typeof e.bus.publish!="function")throw new Error("HIDClientSim requires a bus with a publish(report) method.");this.bus=e.bus,this.commandBus=e.commandBus,this.commandBus&&(this._commandUnsubscribe=this.commandBus.subscribe(t=>this._onCommand(t)))}bus;commandBus;_commandUnsubscribe;_statusListeners=new Set;_streamTimer=null;_reportIndex=0;_connected=!1;isSupported(){return!0}isConnected(){return this._connected}onStatus(e){return this._statusListeners.add(e),e(this._connected?"Connected: HID Simulator":"Disconnected"),()=>this._statusListeners.delete(e)}async connect(){this._connected||(this._connected=!0,this._emitStatus("Connected: HID Simulator"),this._streamTimer=window.setInterval(()=>this._publishSineReport(),10))}async disconnect(){this._streamTimer!==null&&(window.clearInterval(this._streamTimer),this._streamTimer=null),this._connected=!1,this._emitStatus("Disconnected")}destroy(){this._commandUnsubscribe&&this._commandUnsubscribe(),this.disconnect()}_emitStatus(e){for(const t of this._statusListeners)t(e)}_publishSineReport(){if(!this._connected)return;const e=2*Math.PI*this._reportIndex/500,t=Math.sin(e),i=new Array(16).fill(t),s=i.map(n=>Math.round(n*1e3));this.bus.publish({reportId:0,timestampMs:performance.now(),device:null,CommandBytes:[128,0,0,0],floatValues:i,intValues:s,byteLength:64,rawBytes:this._encodeRawBytes(i)}),this._reportIndex+=1}_encodeRawBytes(e){const t=new Uint8Array(64);t[0]=128;const i=new DataView(t.buffer),s=Math.min(15,e.length);for(let n=0;n<s;n+=1)i.setFloat32(4+n*4,e[n],!0);return t}_onCommand(e){if(!this._connected)return;const i=e.type==="hid_send"&&e.bytes instanceof Uint8Array?e.bytes:e.data instanceof Uint8Array?e.data:null;if(!i)return;const s=new Uint8Array(64);s.set(i.subarray(0,64));const n=new DataView(s.buffer),a=[],o=[];for(let c=0;c<15;c+=1){const l=4+c*4;a.push(n.getFloat32(l,!0)),o.push(n.getInt32(l,!0))}this.bus.publish({reportId:0,timestampMs:performance.now(),device:null,CommandBytes:[s[0],s[1],s[2],s[3]],floatValues:a,intValues:o,byteLength:s.length,rawBytes:s})}}class G{_buf;_head=0;_count=0;constructor(e){if(!Number.isInteger(e)||e<=0)throw new Error(`RingBuffer capacity must be a positive integer (received ${e}).`);this._buf=new Array(e)}capacity(){return this._buf.length}size(){return this._count}push(e){this._buf[this._head]=e,this._head=(this._head+1)%this.capacity(),this._count<this.capacity()&&(this._count+=1)}clear(){this._head=0,this._count=0}forEachInOrder(e){const t=(this._head-this._count+this.capacity())%this.capacity();for(let i=0;i<this._count;i+=1){const s=(t+i)%this.capacity();e(this._buf[s],i)}}latest(){if(this._count===0)return;const e=(this._head-1+this.capacity())%this.capacity();return this._buf[e]}}function de({title:r,hint:e,pos:t,size:i}){const s=document.createElement("section");s.className="panel",s.style.order=String(t),i?.w&&(s.style.width=`${i.w}px`),i?.h&&(s.style.height=`${i.h}px`);const n=document.createElement("div");n.className="panelHeader";const a=document.createElement("h2");a.className="panelTitle",a.textContent=r;const o=document.createElement("div");o.className="panelHint",o.textContent=e||"",n.appendChild(a),n.appendChild(o);const c=document.createElement("div");return c.className="panelBody",s.appendChild(n),s.appendChild(c),{panel:s,body:c,titleEl:a}}class I{panelEl;bodyEl;titleEl;baseSizing;title;minimizedTextContent;_minimized;_isTabVisible;_minimizedBeforeTabHide;constructor({panelEl:e,bodyEl:t,titleEl:i,title:s,minimizedTextContent:n="",initialTabVisible:a=!0}){if(!(e instanceof HTMLElement))throw new Error("PanelWidget requires a panel element.");if(!(t instanceof HTMLElement))throw new Error("PanelWidget requires a body element.");if(!(i instanceof HTMLElement))throw new Error("PanelWidget requires a title element.");this.panelEl=e,this.bodyEl=t,this.titleEl=i,this.baseSizing={width:e.style.width,height:e.style.height,minWidth:e.style.minWidth,minHeight:e.style.minHeight},this.title=s,this.minimizedTextContent=n,this._minimized=!a,this._isTabVisible=a,this._minimizedBeforeTabHide=!1,this.titleEl.addEventListener("dblclick",()=>this.toggleMinimized()),this._applyInitialTabVisibilityState(a),this._renderTitle()}isMinimized(){return this._minimized}isTabVisible(){return this._isTabVisible}toggleMinimized(){this.setMinimized(!this._minimized)}setMinimized(e){this._minimized!==e&&(this._minimized=e,e?this._handleMinimizeInternal():this._handleRestoreInternal())}setTabVisible(e){if(this._isTabVisible!==e){if(!e){this._minimizedBeforeTabHide=this._minimized,this.panelEl.classList.add("panel--tabHidden"),this.setMinimized(!0),this._isTabVisible=!1;return}this.panelEl.classList.remove("panel--tabHidden"),this._isTabVisible=!0,this.setMinimized(this._minimizedBeforeTabHide)}}_handleMinimizeInternal(){this.panelEl.classList.add("panel--minimized"),this._applyMinimizedSizing(),this._renderTitle(!0),this.pause()}_handleRestoreInternal(){this.panelEl.classList.remove("panel--minimized"),this._restoreSizing(),this._renderTitle(!1),this.resume()}_applyInitialTabVisibilityState(e){if(e){this.panelEl.classList.remove("panel--tabHidden"),this.panelEl.classList.remove("panel--minimized"),this._restoreSizing();return}this.panelEl.classList.add("panel--tabHidden"),this.panelEl.classList.add("panel--minimized"),this._applyMinimizedSizing()}_renderTitle(e=this._minimized){if(!e){this.titleEl.textContent=this.title;return}const t=this.title.slice(0,3),i=this.minimizedTextContent===""?t:this.minimizedTextContent;this.titleEl.textContent=i}_applyMinimizedSizing(){this.panelEl.style.width="auto",this.panelEl.style.height="auto",this.panelEl.style.minWidth="0",this.panelEl.style.minHeight="0"}_restoreSizing(){this.panelEl.style.width=this.baseSizing.width,this.panelEl.style.height=this.baseSizing.height,this.panelEl.style.minWidth=this.baseSizing.minWidth,this.panelEl.style.minHeight=this.baseSizing.minHeight}}class he extends I{constructor(e,t,i,s){if(super(e),!(t instanceof HTMLElement))throw new Error("ExportCsvWidget requires a container element.");if(!i||typeof i.subscribe!="function")throw new Error("ExportCsvWidget requires a bus with subscribe(cb)->unsubscribe.");if(!s||typeof s.subscribe!="function")throw new Error("ExportCsvWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=s,this.container=t,this._log=[];const n=document.createElement("div");n.className="exportButtons";const a=document.createElement("button");a.type="button",a.textContent="Clear log",a.addEventListener("click",()=>this.clear());const o=document.createElement("button");o.type="button",o.textContent="Download to CSV",o.addEventListener("click",()=>this.downloadCsv()),n.appendChild(a),n.appendChild(o),t.appendChild(n);const c=document.createElement("div");c.className="exportCounterRow";const l=document.createElement("span");l.className="exportCounterLabel",l.textContent="Currently logged data points:";const u=document.createElement("span");u.className="exportCounterValue",u.textContent="0",c.appendChild(l),c.appendChild(u),t.appendChild(c),this._counterValue=u,this._unsubscribe=i.subscribe(h=>this.handle(h)),this.isTabVisible()&&this.resume()}container;_log;_scheduler;_unsubscribe;_unsubscribeTick;_counterValue;pause(){this._unsubscribeTick&&(this._unsubscribeTick(),this._unsubscribeTick=void 0)}resume(){this._unsubscribeTick||(this._unsubscribeTick=this._scheduler.subscribe(p.Hz1,()=>this.updateCounter()))}destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeTick&&this._unsubscribeTick()}clear(){this._log.length=0,this.updateCounter()}handle(e){if(e.CommandBytes[0]!==128)return;const t=[...e.CommandBytes,...e.floatValues,...e.intValues];this._log.push(t)}updateCounter(){this._counterValue&&(this._counterValue.textContent=`${this._log.length}`)}downloadCsv(){const t=[...Array.from({length:4},(c,l)=>`cmd${l}`),...Array.from({length:15},(c,l)=>`f${l+1}`),...Array.from({length:15},(c,l)=>`i${l+1}`)].join(","),i=this._log.map(c=>c.join(",")),s=[t,...i].join(`
`),n=new Blob([s],{type:"text/csv;charset=utf-8"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`hid-reports-${Date.now()}.csv`,o.click(),URL.revokeObjectURL(a)}}class me extends I{constructor(e,t,i,s,n={}){if(super(e),!(t instanceof HTMLTextAreaElement))throw new Error("LogWidget requires a textarea element.");if(!i||typeof i.subscribe!="function")throw new Error("LogWidget requires a bus with subscribe(cb)->unsubscribe.");if(!s||typeof s.subscribe!="function")throw new Error("LogWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=s,this.el=t,this.maxLines=n.maxLines??1e3,this.formatter=n.formatter??(a=>`${a.floatValues[0]} ${a.floatValues[1]} ${a.floatValues[2]} ${a.floatValues[3]}`),this.updateRate=n.updateRate??p.Hz25,this._lines=new G(this.maxLines),this._unsubscribe=i.subscribe(a=>this.handle(a)),this.isTabVisible()&&this.resume()}el;maxLines;formatter;updateRate;_lines;_scheduler;_unsubscribe;_unsubscribeTick;pause(){this._unsubscribeTick&&(this._unsubscribeTick(),this._unsubscribeTick=void 0)}resume(){this._unsubscribeTick||(this._unsubscribeTick=this._scheduler.subscribe(this.updateRate,()=>this.flush()))}destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeTick&&this._unsubscribeTick()}clear(){this.el.value="",this._lines.clear()}handle(e){if(e.CommandBytes[0]!==128)return;const t=this.formatter(e);this._lines.push(t)}flush(){if(this._lines.size()===0)return;const e=[];this._lines.forEachInOrder(t=>e.push(t)),this.el.value=e.length?`${e.join(`
`)}
`:"",this.el.scrollTop=this.el.scrollHeight}}const $=4;function w(r){if(!Number.isFinite(r))return"";const e=Math.abs(r);return e!==0&&(e>=1e4||e<.001)?r.toExponential($-1):r.toPrecision($)}class pe extends I{constructor(e,t,i,s,n={}){if(super(e),!(t instanceof HTMLElement))throw new Error("PlotWidget requires a container element.");if(!i||typeof i.subscribe!="function")throw new Error("PlotWidget requires a bus with subscribe(cb)->unsubscribe.");if(!s||typeof s.subscribe!="function")throw new Error("PlotWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=s,t.classList.add("plotStack"),this.container=t,this.axesLayer=this._createLayer("axes",1),this.traceLayer=this._createLayer("trace",2),this.overlayLayer=this._createLayer("overlay",3),this.overlayValueEl=document.createElement("span"),this.overlayValueEl.className="plotHoverOverlay",this.overlayValueEl.setAttribute("role","status"),this.overlayValueEl.setAttribute("aria-live","polite"),this.container.appendChild(this.overlayValueEl),this.valueSelector=n.valueSelector??(a=>a.floatValues[0]),this.maxPoints=n.maxPoints??1e3,this.padding=n.padding??100,this.updateRate=n.updateRate??p.Hz25,this.axesUpdateRate=n.axesUpdateRate??p.Hz5,this.traceUpdateRate=n.traceUpdateRate??this.updateRate,this.label=n.label??"",this.buf=new G(this.maxPoints),this._unsubscribe=i.subscribe(a=>this.handle(a)),this.isTabVisible()&&this.resume(),this._boundOnResize=()=>{this.drawAxes(),this.drawTrace(),this.drawOverlay()},window.addEventListener("resize",this._boundOnResize),this._boundOnMouseMove=a=>{this._hoverXDevice=this._clientXToDeviceX(a.clientX)},this._boundOnMouseLeave=()=>{this._hoverXDevice=null},this.overlayLayer.canvas.addEventListener("mousemove",this._boundOnMouseMove),this.overlayLayer.canvas.addEventListener("mouseleave",this._boundOnMouseLeave),this.drawAxes(),this.drawTrace(),this.drawOverlay()}container;axesLayer;traceLayer;overlayLayer;overlayValueEl;valueSelector;maxPoints;padding;updateRate;axesUpdateRate;traceUpdateRate;label;buf;_unsubscribe;_scheduler;_unsubscribeAxesTick;_unsubscribeTraceTick;_bounds;_traceValues=[];_hoverXDevice=null;_boundOnResize;_boundOnMouseMove;_boundOnMouseLeave;_hasSeededInitialWindow=!1;destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeAxesTick&&this._unsubscribeAxesTick(),this._unsubscribeTraceTick&&this._unsubscribeTraceTick(),this._boundOnResize&&window.removeEventListener("resize",this._boundOnResize),this._boundOnMouseMove&&this.overlayLayer.canvas.removeEventListener("mousemove",this._boundOnMouseMove),this._boundOnMouseLeave&&this.overlayLayer.canvas.removeEventListener("mouseleave",this._boundOnMouseLeave),this.overlayValueEl.remove()}clear(){this.buf.clear(),this._hasSeededInitialWindow=!1,this._traceValues=[],this.drawAxes(),this.drawTrace(),this.drawOverlay()}pause(){this._unsubscribeAxesTick&&(this._unsubscribeAxesTick(),this._unsubscribeAxesTick=void 0),this._unsubscribeTraceTick&&(this._unsubscribeTraceTick(),this._unsubscribeTraceTick=void 0)}resume(){this._unsubscribeAxesTick||(this._unsubscribeAxesTick=this._scheduler.subscribe(this.axesUpdateRate,()=>this.drawAxes())),this._unsubscribeTraceTick||(this._unsubscribeTraceTick=this._scheduler.subscribe(this.traceUpdateRate,()=>{this.drawTrace(),this.drawOverlay()}))}handle(e){if(e.CommandBytes[0]!==128)return;const t=this.valueSelector(e);Number.isFinite(t)&&(this._seedInitialWindowIfNeeded(),this.buf.push(t))}_seedInitialWindowIfNeeded(){if(this._hasSeededInitialWindow||this.buf.size()>0)return;const e=Math.max(0,this.maxPoints-1);for(let t=0;t<e;t+=1)this.buf.push(0);this._hasSeededInitialWindow=!0}_resizeLayersToDisplaySize(){const e=window.devicePixelRatio||1,t=this.container.getBoundingClientRect(),i=Math.max(1,Math.floor(t.width*e)),s=Math.max(1,Math.floor(t.height*e));for(const n of[this.axesLayer,this.traceLayer,this.overlayLayer])(n.canvas.width!==i||n.canvas.height!==s)&&(n.canvas.width=i,n.canvas.height=s)}_getLayout(e,t){const o=Math.max(1,e-56-10),c=Math.max(1,t-10-24);return{left:56,right:10,top:10,bottom:24,plotW:o,plotH:c}}_computeBounds(){if(this.buf.size()===0)return null;let e=1/0,t=-1/0;this.buf.forEachInOrder(n=>{n<e&&(e=n),n>t&&(t=n)});let i=e-this.padding,s=t+this.padding;return(!Number.isFinite(i)||!Number.isFinite(s)||i===s)&&(i=-1,s=1),i>0&&(i=0),s<0&&(s=0),{yMin:i,yMax:s}}drawAxes(){this._resizeLayersToDisplaySize();const e=this.axesLayer.ctx,t=this.axesLayer.canvas.width,i=this.axesLayer.canvas.height,s=this._getThemeColors();if(e.clearRect(0,0,t,i),e.strokeStyle=s.axis,e.fillStyle=s.text,this.buf.size()===0){e.fillText("Not Connected",10,20),this._bounds=void 0;return}const n=this._computeBounds();if(!n){this._bounds=void 0;return}this._bounds=n;const{left:a,top:o,plotW:c,plotH:l}=this._getLayout(t,i);e.beginPath(),e.moveTo(a,o),e.lineTo(a,o+l),e.lineTo(a+c,o+l),e.stroke();const u=21,h=5,m=new Set;for(let d=0;d<h;d+=1){const y=Math.round(d*(u-1)/(h-1));m.add(y)}e.textAlign="right",e.textBaseline="middle";for(let d=0;d<u;d+=1){const y=d/(u-1),f=o+(1-y)*l,g=n.yMin+y*(n.yMax-n.yMin);e.beginPath(),e.moveTo(a-6,f),e.lineTo(a,f),e.stroke(),m.has(d)&&e.fillText(w(g),a-8,f)}}drawTrace(){this._resizeLayersToDisplaySize();const e=this.traceLayer.ctx,t=this.traceLayer.canvas.width,i=this.traceLayer.canvas.height,s=this._getThemeColors();if(e.clearRect(0,0,t,i),e.strokeStyle=s.trace,e.fillStyle=s.text,this.buf.size()===0){this._traceValues=[];return}const n=this._bounds??this._computeBounds();if(!n)return;const{left:a,top:o,plotW:c,plotH:l}=this._getLayout(t,i),u=this.buf.size(),h=Math.max(1,u-1),m=[],d=b=>a+b/h*c,y=b=>{const x=(b-n.yMin)/(n.yMax-n.yMin);return o+(1-x)*l};e.beginPath();let f=!0;this.buf.forEachInOrder((b,x)=>{m.push(b);const A=d(x),D=y(b);f?(e.moveTo(A,D),f=!1):e.lineTo(A,D)}),e.stroke(),this._traceValues=m;const g=this.buf.latest();if(typeof g=="number"){const b=this.label?`${this.label} `:"";e.fillText(`Current ${b}: ${w(g)}`,a+6,i-6)}}drawOverlay(){this._resizeLayersToDisplaySize();const e=this.overlayLayer.ctx,t=this.overlayLayer.canvas.width,i=this.overlayLayer.canvas.height,s=this._getThemeColors();if(e.clearRect(0,0,t,i),this._hoverXDevice===null){this.overlayValueEl.classList.remove("plotHoverOverlay--visible");return}const{left:n,top:a,plotW:o,plotH:c}=this._getLayout(t,i),l=Math.max(n,Math.min(n+o,this._hoverXDevice));if(this._traceValues.length===0){this._positionOverlayLabel(n+o/2,a+c/2,"no data");return}const u=this._bounds??this._computeBounds();if(!u){this._positionOverlayLabel(n+o/2,a+c/2,"no data");return}const h=Math.max(1,this._traceValues.length-1),m=(l-n)/o,d=Math.max(0,Math.min(this._traceValues.length-1,Math.round(m*h))),y=this._traceValues[d],f=n+d/h*o,g=(y-u.yMin)/(u.yMax-u.yMin),b=a+(1-g)*c;e.strokeStyle=s.axis,e.beginPath(),e.moveTo(f,a),e.lineTo(f,a+c),e.stroke(),e.fillStyle=s.trace,e.beginPath(),e.arc(f,b,3,0,Math.PI*2),e.fill();const x=this.label?`${this.label} `:"";this._positionOverlayLabel(f,b,`${x}${w(y)}`)}_positionOverlayLabel(e,t,i){const s=window.devicePixelRatio||1,n=e/s,a=t/s;this.overlayValueEl.textContent=i,this.overlayValueEl.style.left=`${n}px`,this.overlayValueEl.style.top=`${Math.max(4,a-10)}px`,this.overlayValueEl.classList.add("plotHoverOverlay--visible")}_clientXToDeviceX(e){const t=this.overlayLayer.canvas.getBoundingClientRect(),i=t.width>0?this.overlayLayer.canvas.width/t.width:1;return(e-t.left)*i}_createLayer(e,t){const i=document.createElement("canvas");i.className="plotLayer",i.dataset.layer=e,i.style.zIndex=String(t),this.container.appendChild(i);const s=i.getContext("2d");if(!s)throw new Error("PlotWidget requires a 2D rendering context.");return{name:e,canvas:i,ctx:s}}_getThemeColors(){const e=getComputedStyle(this.container),t=(i,s)=>e.getPropertyValue(i).trim()||s;return{text:t("--color-text","#e4edf5"),axis:t("--color-muted","#9fb1c5"),trace:t("--color-accent","#5aa4ff")}}}function fe(r){if(r.length!==64)throw new Error(`Report ${r.commandId} must be exactly 64 bytes.`);const e=[...r.fields].sort((t,i)=>t.offset-i.offset);for(const t of e){if(t.offset<4||t.offset>60)throw new Error(`Field ${t.name} in report ${r.commandId} must be in byte range [4, 60].`);if(t.offset%4!==0)throw new Error(`Field ${t.name} in report ${r.commandId} must be 4-byte aligned.`);if(t.type!=="f32"&&t.type!=="i32")throw new Error(`Field ${t.name} in report ${r.commandId} has unsupported type ${String(t.type)}.`)}for(let t=1;t<e.length;t+=1){const i=e[t-1],s=e[t],n=i.offset+4;if(s.offset<n)throw new Error(`Fields ${i.name} and ${s.name} overlap in report ${r.commandId}.`)}}function be(r){return{name:r.name,label:r.label,offset:r.offset,type:r.type,parser:r.type==="f32"?"float":"int",readOnly:r.readOnly??!1,units:r.units??"",default:r.default,min:r.min,max:r.max,step:r.step,placeholder:r.placeholder,uiOrder:r.uiOrder,widgetMeta:r.widgetMeta}}function ye(r){return fe(r),r.fields.map(e=>be(e)).sort((e,t)=>{const i=e.uiOrder,s=t.uiOrder;if(typeof i=="number"||typeof s=="number"){const n=typeof i=="number"?i:Number.MAX_SAFE_INTEGER,a=typeof s=="number"?s:Number.MAX_SAFE_INTEGER;if(n!==a)return n-a}return e.offset-t.offset})}function q(r,e){const t=r.widgetMeta?.constraintsByProfile;if(!t)return{min:r.min,max:r.max};const i=t[v],s=t[e];return{min:s?.min??i?.min??r.min,max:s?.max??i?.max??r.max}}const j=-2147483648,K=2147483647;function we(r,e){let t=r;return typeof e.min=="number"&&t<e.min&&(t=e.min),typeof e.max=="number"&&t>e.max&&(t=e.max),t}function ve(r,e){return r==="int"?/^-?\d+$/.test(e):/^-?(?:\d+\.?\d*|\.\d+)(?:[eE][+-]?\d+)?$/.test(e)}function _e(r,e){return Number.isFinite(e)?r!=="int"?!0:Number.isInteger(e)&&e>=j&&e<=K:!1}function Y(r){const{parser:e,constraints:t,rawText:i,formatFloat:s}=r,n=i.trim();if(n.length===0||!ve(e,n))return{isAccepted:!1,normalizedValue:"",shouldShowTooltip:!0,wasClipped:!1};const a=e==="float"?Number.parseFloat(n):Number.parseInt(n,10);if(!_e(e,a))return{isAccepted:!1,normalizedValue:"",shouldShowTooltip:!0,wasClipped:!1};const o=we(a,t);return{isAccepted:!0,normalizedValue:e==="int"?`${Math.trunc(o)}`:s(o),shouldShowTooltip:o!==a,wasClipped:o!==a}}function U(r,e){return r.parser==="int"?`${Math.trunc(e)}`:`${Number(e.toPrecision(3))}`}function R(r,e){const t=typeof e.min=="number"?U(r,e.min):"-∞",i=typeof e.max=="number"?U(r,e.max):"+∞",s=r.parser==="int"?"integer":"float";return`${r.label} must be ${s} between ${t} and ${i}.`}class Ee extends I{txBus;panelConfig;reportSpec;fieldBindings;errorEl;receivedDataEl;_unsubscribeReport;_unsubscribeDeviceProfile;activeProfileCode=v;constructor(e,t,i,s,n,a){if(super(e),!t||typeof t.publish!="function")throw new Error("CommandPanelWidget requires a command bus with publish().");if(!i||typeof i.subscribe!="function")throw new Error("CommandPanelWidget requires a report bus with subscribe().");if(!s||typeof s.subscribe!="function")throw new Error("CommandPanelWidget requires a device profile bus with subscribe().");this.txBus=t,this.panelConfig=n,this.reportSpec=a,this.fieldBindings=[],this.errorEl=document.createElement("div"),this.errorEl.className="commandPanelError",this.errorEl.textContent="",this.receivedDataEl=document.createElement("div"),this.receivedDataEl.className="commandPanelReceived",this.receivedDataEl.textContent="Data Received:",this.render(e.bodyEl),this._unsubscribeReport=i.subscribe(o=>this.handleReport(o)),this._unsubscribeDeviceProfile=s.subscribe(o=>this.handleDeviceProfile(o))}pause(){}resume(){}destroy(){this._unsubscribeReport&&this._unsubscribeReport(),this._unsubscribeDeviceProfile&&this._unsubscribeDeviceProfile();for(const e of this.fieldBindings)this.clearTooltipTimers(e);this.fieldBindings.length=0}render(e){e.innerHTML="";const t=document.createElement("div");t.className="commandPanelFields";for(const s of ye(this.reportSpec)){const n=document.createElement("label");n.className="commandPanelRow",n.htmlFor=this.inputId(s.name);const a=document.createElement("span");a.className="commandPanelFieldLabel",a.textContent=s.label;const o=document.createElement("span");o.className="commandPanelInputWrap";const c=document.createElement("input");c.className="commandPanelInput",c.id=this.inputId(s.name),c.type="text",c.readOnly=s.readOnly,s.placeholder&&(c.placeholder=s.placeholder);const l=typeof s.default=="number"?s.default:0;c.value=s.parser==="int"?`${Math.trunc(l)}`:w(l),typeof s.step=="number"&&(c.step=`${s.step}`);const u=document.createElement("span");u.className="commandPanelUnits",u.textContent=s.units;const h=document.createElement("span");h.className="commandPanelTooltip",h.setAttribute("role","status"),h.setAttribute("aria-live","polite");const m={spec:s,input:c,tooltipEl:h,lastValidValue:c.value,constraints:q(s,this.activeProfileCode)};this.applyInputConstraints(m),c.addEventListener("keydown",d=>this.handleFieldKeydown(d,m)),c.addEventListener("blur",()=>this.enforceCommittedFieldValue(m)),c.addEventListener("mouseenter",()=>this.scheduleHoverTooltip(m)),c.addEventListener("mouseleave",()=>this.clearHoverTimer(m)),o.appendChild(c),o.appendChild(h),n.appendChild(a),n.appendChild(o),n.appendChild(u),t.appendChild(n),this.fieldBindings.push(m)}const i=document.createElement("button");i.className="commandPanelSend",i.type="button",i.textContent=this.panelConfig.buttonLabel??this.reportSpec.widgetUi?.buttonLabel??"Send",i.addEventListener("click",()=>this.handleSend()),e.appendChild(t),e.appendChild(i),e.appendChild(this.errorEl),e.appendChild(this.receivedDataEl)}handleDeviceProfile(e){this.activeProfileCode=e;for(const t of this.fieldBindings)t.constraints=q(t.spec,this.activeProfileCode),this.applyInputConstraints(t),this.enforceCommittedFieldValue(t)}applyInputConstraints(e){typeof e.constraints.min=="number"?e.input.min=`${e.constraints.min}`:e.input.removeAttribute("min"),typeof e.constraints.max=="number"?e.input.max=`${e.constraints.max}`:e.input.removeAttribute("max")}handleReport(e){if(e.CommandBytes[0]!==this.panelConfig.commandId)return;const t=new DataView(e.rawBytes.buffer,e.rawBytes.byteOffset,e.rawBytes.byteLength),i=[];for(const s of this.fieldBindings){const n=s.spec.type==="f32"?t.getFloat32(s.spec.offset,!0):t.getInt32(s.spec.offset,!0);s.input.value=s.spec.parser==="int"?`${Math.trunc(n)}`:w(n),s.lastValidValue=s.input.value;const a=s.spec.type==="f32"?n.toPrecision(3):`${n}`;i.push(a)}this.receivedDataEl.textContent=`Data Received: ${i.join(", ")}`}handleFieldKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),this.enforceCommittedFieldValue(t),t.input.blur())}enforceCommittedFieldValue(e){const t=Y({parser:e.spec.parser,constraints:e.constraints,rawText:e.input.value,formatFloat:w});if(!t.isAccepted){e.input.value=e.lastValidValue,t.shouldShowTooltip&&this.showTooltip(e,R(e.spec,e.constraints));return}e.input.value=t.normalizedValue,e.lastValidValue=t.normalizedValue,t.shouldShowTooltip&&this.showTooltip(e,R(e.spec,e.constraints))}scheduleHoverTooltip(e){this.clearHoverTimer(e),e.hoverTimerId=window.setTimeout(()=>{this.showTooltip(e,R(e.spec,e.constraints)),e.hoverTimerId=void 0},1e3)}clearHoverTimer(e){typeof e.hoverTimerId=="number"&&window.clearTimeout(e.hoverTimerId),e.hoverTimerId=void 0}showTooltip(e,t){this.clearTooltipTimers(e),e.tooltipEl.textContent=t,e.tooltipEl.classList.add("commandPanelTooltip--visible"),e.tooltipEl.classList.remove("commandPanelTooltip--fading"),e.fadeTimerId=window.setTimeout(()=>{e.tooltipEl.classList.add("commandPanelTooltip--fading")},2e3),e.hideTimerId=window.setTimeout(()=>{e.tooltipEl.classList.remove("commandPanelTooltip--visible","commandPanelTooltip--fading")},3e3)}clearTooltipTimers(e){this.clearHoverTimer(e),typeof e.fadeTimerId=="number"&&window.clearTimeout(e.fadeTimerId),typeof e.hideTimerId=="number"&&window.clearTimeout(e.hideTimerId),e.fadeTimerId=void 0,e.hideTimerId=void 0}handleSend(){this.clearError(),this.clearInputErrors();const e=new Uint8Array(64);e[0]=this.panelConfig.commandId;const t=new DataView(e.buffer);for(const i of this.fieldBindings){if(i.spec.readOnly)continue;const s=i.input.value.trim(),n=i.spec.parser==="float"?Number.parseFloat(s):Number.parseInt(s,10);if(!Number.isFinite(n)){this.setFieldError(i.input,`${i.spec.label} is not a valid number.`);return}if(i.spec.parser==="int"&&(!Number.isInteger(n)||n<j||n>K)){this.setFieldError(i.input,`${i.spec.label} must be a valid int32 value.`);return}if(typeof i.constraints.min=="number"&&n<i.constraints.min){this.setFieldError(i.input,`${i.spec.label} must be >= ${i.constraints.min}.`);return}if(typeof i.constraints.max=="number"&&n>i.constraints.max){this.setFieldError(i.input,`${i.spec.label} must be <= ${i.constraints.max}.`);return}i.spec.type==="f32"?t.setFloat32(i.spec.offset,n,!0):t.setInt32(i.spec.offset,n,!0)}this.txBus.publish({type:"hid_send",commandId:this.panelConfig.commandId,bytes:e,length:64,timestampMs:performance.now()})}inputId(e){return`cmd-${this.panelConfig.commandId}-${e}`}setFieldError(e,t){e.classList.add("commandPanelInput--error"),this.errorEl.textContent=t}clearInputErrors(){for(const e of this.fieldBindings)e.input.classList.remove("commandPanelInput--error")}clearError(){this.errorEl.textContent=""}}const z=64,M=129,Te=1,ge=0,Ce=10;class xe extends I{txBus;controls;inputBindings=[];sweepTimerId;sweepStartTimeMs=0;phaseRadians=0;startFrequencyHz=0;stopFrequencyHz=0;durationSeconds=0;amplitude=1;frequencySlopeHzPerSecond=0;lastTickTimestampMs=0;constructor(e,t){super(e),this.txBus=t,this.controls=this.render(e.bodyEl),this.syncButtonState()}pause(){}resume(){}destroy(){this.stopSweep(!0),this.inputBindings.length=0}render(e){e.innerHTML="";const t=document.createElement("div");t.className="sineSweepFields";const i=this.buildInputRow(t,"Start Frequency","1"),s=this.buildInputRow(t,"Stop Frequency","5"),n=this.buildInputRow(t,"Duration (seconds)","4"),a=this.buildInputRow(t,"Amplitude","1");this.inputBindings=[this.createInputBinding("Start Frequency",i),this.createInputBinding("Stop Frequency",s),this.createInputBinding("Duration (seconds)",n,0),this.createInputBinding("Amplitude",a)];const o=document.createElement("div");o.className="sineSweepButtons";const c=document.createElement("button");c.type="button",c.textContent="Start",c.addEventListener("click",()=>this.startSweep());const l=document.createElement("button");l.type="button",l.textContent="Stop",l.addEventListener("click",()=>this.stopSweep(!0)),o.append(c,l);const u=document.createElement("div");u.className="sineSweepCurrentFrequency";const h=document.createElement("span");h.textContent="Current Frequency:";const m=document.createElement("span");m.textContent="-",u.append(h,m);const d=document.createElement("div");return d.className="commandPanelError",t.append(o,u,d),e.append(t),{startFrequencyInput:i,stopFrequencyInput:s,durationInput:n,amplitudeInput:a,startButton:c,stopButton:l,currentFrequencyValue:m,errorEl:d}}buildInputRow(e,t,i){const s=document.createElement("label");s.className="commandPanelRow";const n=document.createElement("span");n.className="commandPanelFieldLabel",n.textContent=t;const a=document.createElement("span");a.className="commandPanelInputWrap";const o=document.createElement("input");return o.className="commandPanelInput",o.type="text",o.value=i,a.append(o),s.append(n,a),e.append(s),o}createInputBinding(e,t,i){const s={label:e,input:t,lastValidValue:t.value,min:i};return t.addEventListener("keydown",n=>this.handleInputKeydown(n,s)),t.addEventListener("blur",()=>this.enforceCommittedInput(s)),s}handleInputKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),this.enforceCommittedInput(t),t.input.blur())}enforceCommittedInput(e){const t=Y({parser:"float",constraints:{min:e.min},rawText:e.input.value,formatFloat:w});if(!t.isAccepted){e.input.value=e.lastValidValue,this.controls.errorEl.textContent=`${e.label} must be a float${typeof e.min=="number"?` >= ${e.min}`:""}.`;return}e.input.value=t.normalizedValue,e.lastValidValue=t.normalizedValue,this.controls.errorEl.textContent=""}readSweepParameters(){for(const e of this.inputBindings)this.enforceCommittedInput(e);return{startFrequencyHz:Number.parseFloat(this.controls.startFrequencyInput.value.trim()),stopFrequencyHz:Number.parseFloat(this.controls.stopFrequencyInput.value.trim()),durationSeconds:Number.parseFloat(this.controls.durationInput.value.trim()),amplitude:Number.parseFloat(this.controls.amplitudeInput.value.trim())}}startSweep(){if(this.sweepTimerId!==void 0)return;const e=this.readSweepParameters();this.startFrequencyHz=e.startFrequencyHz,this.stopFrequencyHz=e.stopFrequencyHz,this.durationSeconds=e.durationSeconds,this.amplitude=e.amplitude,this.frequencySlopeHzPerSecond=(this.stopFrequencyHz-this.startFrequencyHz)/this.durationSeconds,this.sweepStartTimeMs=performance.now(),this.lastTickTimestampMs=this.sweepStartTimeMs,this.phaseRadians=0,this.controls.currentFrequencyValue.textContent=`${w(this.startFrequencyHz)} Hz`,this.publishSweepReport(0),this.sweepTimerId=window.setInterval(()=>this.handleSweepTick(),Ce),this.syncButtonState()}handleSweepTick(){const e=performance.now(),t=(e-this.sweepStartTimeMs)/1e3;if(t>=this.durationSeconds){this.stopSweep(!0);return}const i=this.startFrequencyHz+this.frequencySlopeHzPerSecond*t,s=(e-this.lastTickTimestampMs)/1e3;this.lastTickTimestampMs=e,this.phaseRadians+=2*Math.PI*i*s;const n=this.amplitude*Math.sin(this.phaseRadians);this.controls.currentFrequencyValue.textContent=`${w(i)} Hz`,this.publishSweepReport(n)}stopSweep(e){if(this.sweepTimerId!==void 0&&(window.clearInterval(this.sweepTimerId),this.sweepTimerId=void 0),e){const t=new Uint8Array(z);t[0]=M,t[1]=ge,this.txBus.publish({type:"hid_send",commandId:M,bytes:t,length:z,timestampMs:performance.now()})}this.controls.currentFrequencyValue.textContent="-",this.syncButtonState()}publishSweepReport(e){const t=new Uint8Array(z);t[0]=M,t[1]=Te,new DataView(t.buffer).setFloat32(4,e,!0),this.txBus.publish({type:"hid_send",commandId:M,bytes:t,length:z,timestampMs:performance.now()})}syncButtonState(){const e=this.sweepTimerId!==void 0;this.controls.startButton.disabled=e,this.controls.stopButton.disabled=!e}}const _=34028234663852886e22,E=-_,Se=2147483647,Ie=-2147483648,Le={2:{commandId:2,name:"Auto Characterize",length:64,widgetUi:{buttonLabel:"Characterize",instantiateGenericCommandWidget:!0},fields:[{name:"resistance",label:"Resistance",offset:4,type:"f32",endian:"le",units:"Ohms",widgetMeta:{constraintsByProfile:{0:{min:E,max:_}}}},{name:"ld",label:"Ld",offset:8,type:"f32",endian:"le",units:"Henries",widgetMeta:{constraintsByProfile:{0:{min:E,max:_}}}},{name:"lq",label:"Lq",offset:12,type:"f32",endian:"le",units:"Henries",widgetMeta:{constraintsByProfile:{0:{min:E,max:_}}}},{name:"fluxLinkage",label:"Flux Linkage",offset:16,type:"f32",endian:"le",units:"Weber",widgetMeta:{constraintsByProfile:{0:{min:E,max:_}}}},{name:"statusCode",label:"Status Code",offset:20,type:"i32",endian:"le",units:"",widgetMeta:{constraintsByProfile:{0:{min:Ie,max:Se}}}}]},4:{commandId:4,name:"Power Config",length:64,widgetUi:{buttonLabel:"Set Power Limits",instantiateGenericCommandWidget:!0},fields:[{name:"motorCurrent",label:"Motor Current",offset:4,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:E,max:_},22288:{min:0,max:40}}}},{name:"batteryCurrentDischarge",label:"Battery Current Discharge",offset:8,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:E,max:_},22288:{min:0,max:40}}}},{name:"batteryCurrentRegen",label:"Battery Current Regen",offset:12,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:E,max:_},22288:{min:0,max:40}}}}]}},J=document.getElementById("dashboard");if(!J)throw new Error("Missing required UI elements.");const ze=J,P=new URLSearchParams(window.location.search).get("sim")==="1",Me=()=>{const r=document.createElement("div");r.className="topbar dashboardControls";const e=document.createElement("div");e.className="topbarLeft";const t=document.createElement("div");t.className="topbarCenter";const i=document.createElement("div");i.className="topbarRight";const s=document.createElement("button");s.id="connectBtn",s.textContent="Connect";const n=document.createElement("div");n.className="topbarGroup",n.append(s);const a=document.createElement("div");a.id="status",a.className="status",a.textContent="Disconnected";const o=document.createElement("button");o.id="simulateBtn",o.textContent=P?"Exit Sim":"Simulate",o.addEventListener("click",()=>{const l=new URL(window.location.href);P?l.searchParams.delete("sim"):l.searchParams.set("sim","1"),window.location.href=l.toString()});const c=document.createElement("a");return c.className="topbarLink",c.href=new URL("one-pager/",window.location.href).toString(),c.textContent="Chiralight Advantage",c.target="_blank",c.rel="noreferrer",c.title="Opens in New Tab",n.append(a,o),e.append(n),t.append(c),r.append(e,t,i),{headerEl:r,connectBtn:s,statusEl:a,rightSlotEl:i}},{headerEl:Pe,connectBtn:Ve,statusEl:Be}=Me(),L=document.createElement("nav");L.id="tabs";L.className="tabs";L.setAttribute("aria-label","Dashboard tabs");const O=document.createElement("div");O.className="dashboardPanels";ze.append(Pe,L,O);const Q=Ve,V=Be,W=L,X=O,C=new ie,B=new se,H=new re,Z=new ce,T=P?new ue({bus:C,commandBus:B}):new le({bus:C,commandBus:B,deviceProfileBus:Z}),ee=[{id:"realtime",label:"Realtime Data"},{id:"configuration",label:"Configuration"},{id:"control",label:"Control"}],Re=[{tab:"realtime",pos:20,kind:"plot",title:"Motor Speed (rad/s)",hint:"Motor Speed in radians per second",minimizedTextContent:"Mtr Spd",size:{w:520,h:320},plot:{valueSelector:r=>r.floatValues[0],maxPoints:1e3,padding:100,traceUpdateRate:p.Hz25,axesUpdateRate:p.Hz10,label:"Motor Speed"}},{tab:"realtime",pos:30,kind:"plot",title:"Motor Current (A)",hint:"Motor Current in Amperes",minimizedTextContent:"Mtr Cur",size:{w:520,h:320},plot:{valueSelector:r=>r.floatValues[1],maxPoints:1e3,padding:1,traceUpdateRate:p.Hz25,axesUpdateRate:p.Hz10,label:"Motor Current"}},{tab:"realtime",pos:40,kind:"plot",title:"Battery Voltage (V)",hint:"DC Link Voltage in Volts",minimizedTextContent:"Bat Vlt",size:{w:520,h:320},plot:{valueSelector:r=>r.floatValues[2],maxPoints:1e3,padding:10,traceUpdateRate:p.Hz25,axesUpdateRate:p.Hz10,label:"Battery Voltage"}},{tab:"realtime",pos:50,kind:"plot",title:"Battery Current (A)",hint:"DC Link Current in Ampere",minimizedTextContent:"Bat Cur",size:{w:520,h:320},plot:{valueSelector:r=>r.floatValues[3],maxPoints:1e3,padding:1,traceUpdateRate:p.Hz25,axesUpdateRate:p.Hz10,label:"Battery Current"}},{tab:"realtime",pos:60,kind:"plot",title:"MOSFET Temp (°C)",hint:"MOSFET Temperature in °C",minimizedTextContent:"Temp",size:{w:520,h:320},plot:{valueSelector:r=>r.floatValues[9],maxPoints:1e3,padding:1,traceUpdateRate:p.Hz25,axesUpdateRate:p.Hz10,label:"MOSFET Temp"}},{tab:"realtime",pos:100,kind:"export",title:"Export CSV",hint:"Lossless log from 64-byte reports",minimizedTextContent:"CSV",size:{w:420,h:200}},{tab:"configuration",pos:20,kind:"command",title:"Automatic Characterization",hint:"ReportSpec command 2",minimizedTextContent:"Auto Char",size:{w:520,h:340},command:{commandId:2}},{tab:"configuration",pos:30,kind:"command",title:"Power Configuration",hint:"ReportSpec command 4",minimizedTextContent:"Power Cfg",size:{w:520,h:340},command:{commandId:4}},{tab:"control",pos:20,kind:"sineSweep",title:"Sine Sweep",hint:"Command 129 sine sweep control",minimizedTextContent:"Sweep",size:{w:520,h:320}}],N=[],k=new Map;let S=ee[0].id;function He(){X.innerHTML="",N.length=0,k.clear();const r=[...Re].sort((e,t)=>e.pos-t.pos);for(const e of r){const{panel:t,body:i,titleEl:s}=de(e),n={panelEl:t,bodyEl:i,titleEl:s,title:e.title,minimizedTextContent:e.minimizedTextContent??"",initialTabVisible:e.tab===S};let a=null;if(e.kind==="log"){const o=document.createElement("textarea");o.className="log",o.placeholder="Reports...",o.readOnly=!0,i.appendChild(o),a=new me(n,o,C,H,e.log)}else if(e.kind==="plot"){const o=document.createElement("div");o.className="plotStack",i.appendChild(o),a=new pe(n,o,C,H,e.plot)}else if(e.kind==="export"){const o=document.createElement("div");i.appendChild(o),a=new he(n,o,C,H)}else if(e.kind==="command"){const o=Le[e.command.commandId];if(!o)throw new Error(`Missing report spec for commandId ${e.command.commandId}.`);if(o.widgetUi?.instantiateGenericCommandWidget===!1)continue;a=new Ee(n,B,C,Z,e.command,o)}else e.kind==="sineSweep"&&(a=new xe(n,B));X.appendChild(t),a&&(N.push(a),k.set(a,e.tab))}}He();te();function te(){W.innerHTML="";for(const r of ee){const e=document.createElement("button");e.type="button",e.className="tabButton",e.textContent=r.label,e.dataset.tabId=r.id;const t=r.id===S;e.classList.toggle("tabButton--active",t),e.setAttribute("aria-selected",String(t)),e.setAttribute("role","tab"),e.addEventListener("click",()=>Fe(r.id)),W.appendChild(e)}}function Fe(r){if(S!==r){S=r;for(const e of N){const t=k.get(e);t&&e.setTabVisible(t===S)}te()}}T.onStatus(r=>{V.textContent=r,Q.textContent=T.isConnected()?"Disconnect":"Connect"});Q.addEventListener("click",async()=>{if(!T.isSupported()){V.textContent="WebHID not supported in this browser.";return}try{T.isConnected()?await T.disconnect():await T.connect()}catch(r){V.textContent=`Error: ${r instanceof Error?r.message:String(r)}`}});P&&T.connect().catch(r=>{V.textContent=`Error: ${r instanceof Error?r.message:String(r)}`});
