(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();class K{_subs=new Set;subscribe(e){return this._subs.add(e),()=>this._subs.delete(e)}publish(e){for(const t of this._subs)t(e)}clear(){this._subs.clear()}}class J{_subs=new Set;subscribe(e){return this._subs.add(e),()=>this._subs.delete(e)}publish(e){for(const t of this._subs)t(e)}clear(){this._subs.clear()}}var u=(n=>(n.Hz25="25Hz",n.Hz10="10Hz",n.Hz5="5Hz",n.Hz1="1Hz",n))(u||{});const Q={"25Hz":1e3/25,"10Hz":1e3/10,"5Hz":1e3/5,"1Hz":1e3/1};class Y{_subs=new Map;_timers=new Map;_active=!0;constructor(){for(const e of Object.values(u))this._subs.set(e,new Set);this._active=!document.hidden,this._toggleTimers(this._active),document.addEventListener("visibilitychange",()=>{this._active=!document.hidden,this._toggleTimers(this._active)})}subscribe(e,t){const i=this._subs.get(e);if(!i)throw new Error(`Unknown scheduler rate: ${e}`);return i.add(t),this._active&&this._ensureTimer(e),()=>{i.delete(t),i.size===0&&this._clearTimer(e)}}_ensureTimer(e){if(this._timers.has(e))return;const t=window.setInterval(()=>{const i=this._subs.get(e);if(!(!i||i.size===0))for(const s of i)s()},Q[e]);this._timers.set(e,t)}_clearTimer(e){const t=this._timers.get(e);t&&(clearInterval(t),this._timers.delete(e))}_toggleTimers(e){if(!e){for(const t of this._timers.values())clearInterval(t);this._timers.clear();return}for(const[t,i]of this._subs.entries())i.size!==0&&this._ensureTimer(t)}}const _="0",Z=[{vendorId:1155,productId:22288,profileCode:"22288"}];function P(n){if(n==null)return _;const e=String(n).trim();return e.length>0?e:_}function ee(n){if(!n)return _;for(const e of Z)if(!(typeof e.vendorId=="number"&&n.vendorId!==e.vendorId)&&!(typeof e.productId=="number"&&n.productId!==e.productId)&&!(typeof e.productNameIncludes=="string"&&!(n.productName??"").toLowerCase().includes(e.productNameIncludes.toLowerCase())))return P(e.profileCode);return P(n.productId)}class te{subscribers=new Set;currentProfileCode=_;subscribe(e){return this.subscribers.add(e),e(this.currentProfileCode),()=>this.subscribers.delete(e)}publish(e){this.currentProfileCode=P(e);for(const t of this.subscribers)t(this.currentProfileCode)}clear(){this.publish(_)}}class ie{constructor(e){if(!e?.bus||typeof e.bus.publish!="function")throw new Error("HIDClient requires a bus with a publish(report) method.");this.bus=e.bus,this.commandBus=e.commandBus,this.filters=e.filters??[{vendorId:1155,productId:22288}],this.deviceProfileBus=e.deviceProfileBus,this.device=null,this.statusListeners=new Set,this._boundOnInputReport=this._onInputReport.bind(this),this._boundOnDisconnect=this._onDisconnect.bind(this),this._boundOnCommand=this._onCommand.bind(this),this.commandBus&&(this._commandUnsubscribe=this.commandBus.subscribe(this._boundOnCommand))}bus;commandBus;deviceProfileBus;_commandUnsubscribe;filters;device;statusListeners;_boundOnInputReport;_boundOnDisconnect;_boundOnCommand;isSupported(){return"hid"in navigator}isConnected(){return!!this.device&&this.device.opened}onStatus(e){return this.statusListeners.add(e),e(this.isConnected()?"Connected":"Disconnected"),()=>this.statusListeners.delete(e)}_emitStatus(e){for(const t of this.statusListeners)t(e)}async connect(){if(!this.isSupported())throw new Error("WebHID is not supported in this browser.");this.device&&await this.disconnect(),this._emitStatus("Opening device chooser...");const e=await navigator.hid.requestDevice({filters:this.filters});if(!e||e.length===0){this._emitStatus("No device selected.");return}this.device=e[0],await this.device.open(),this.device.addEventListener("inputreport",this._boundOnInputReport),navigator.hid.addEventListener("disconnect",this._boundOnDisconnect),this.deviceProfileBus?.publish(ee(this.device)),this._emitStatus(`Connected: ${this.device.productName||"HID device"}`)}async disconnect(){if(!this.device){this.deviceProfileBus?.publish(_),this._emitStatus("Disconnected");return}try{this.device.removeEventListener("inputreport",this._boundOnInputReport),navigator.hid.removeEventListener("disconnect",this._boundOnDisconnect),this.device.opened&&await this.device.close()}finally{this.device=null,this.deviceProfileBus?.publish(_),this._emitStatus("Disconnected")}}_onDisconnect(e){this.device&&e.device===this.device&&this.disconnect().catch(()=>{})}async _onCommand(e){if(!this.device||!this.device.opened)return;const t=e.type==="hid_send"&&e.bytes instanceof Uint8Array,i=t?0:e.reportId,s=t?e.bytes:e.data;if(typeof i!="number"||!s){this._emitStatus("Send failed: invalid command payload.");return}try{await this.device.sendReport(i,s)}catch(r){this._emitStatus(`Send failed: ${r instanceof Error?r.message:String(r)}`)}}_onInputReport(e){const t=e.data,i=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s=new Uint8Array(64);s.set(i.subarray(0,64));const r=new DataView(s.buffer),o=[r.getUint8(0),r.getUint8(1),r.getUint8(2),r.getUint8(3)],a=[],l=[];for(let c=0;c<15;c+=1){const d=4+c*4;a.push(r.getFloat32(d,!0)),l.push(r.getInt32(d,!0))}this.bus.publish({reportId:e.reportId,timestampMs:performance.now(),device:this.device,CommandBytes:o,floatValues:a,intValues:l,byteLength:s.length,rawBytes:s})}}class F{_buf;_head=0;_count=0;constructor(e){if(!Number.isInteger(e)||e<=0)throw new Error(`RingBuffer capacity must be a positive integer (received ${e}).`);this._buf=new Array(e)}capacity(){return this._buf.length}size(){return this._count}push(e){this._buf[this._head]=e,this._head=(this._head+1)%this.capacity(),this._count<this.capacity()&&(this._count+=1)}clear(){this._head=0,this._count=0}forEachInOrder(e){const t=(this._head-this._count+this.capacity())%this.capacity();for(let i=0;i<this._count;i+=1){const s=(t+i)%this.capacity();e(this._buf[s],i)}}latest(){if(this._count===0)return;const e=(this._head-1+this.capacity())%this.capacity();return this._buf[e]}}function se({title:n,hint:e,pos:t,size:i}){const s=document.createElement("section");s.className="panel",s.style.order=String(t),i?.w&&(s.style.width=`${i.w}px`),i?.h&&(s.style.height=`${i.h}px`);const r=document.createElement("div");r.className="panelHeader";const o=document.createElement("h2");o.className="panelTitle",o.textContent=n;const a=document.createElement("div");a.className="panelHint",a.textContent=e||"",r.appendChild(o),r.appendChild(a);const l=document.createElement("div");return l.className="panelBody",s.appendChild(r),s.appendChild(l),{panel:s,body:l,titleEl:o}}class L{panelEl;bodyEl;titleEl;baseSizing;title;minimizedTextContent;_minimized;_isTabVisible;_minimizedBeforeTabHide;constructor({panelEl:e,bodyEl:t,titleEl:i,title:s,minimizedTextContent:r="",initialTabVisible:o=!0}){if(!(e instanceof HTMLElement))throw new Error("PanelWidget requires a panel element.");if(!(t instanceof HTMLElement))throw new Error("PanelWidget requires a body element.");if(!(i instanceof HTMLElement))throw new Error("PanelWidget requires a title element.");this.panelEl=e,this.bodyEl=t,this.titleEl=i,this.baseSizing={width:e.style.width,height:e.style.height,minWidth:e.style.minWidth,minHeight:e.style.minHeight},this.title=s,this.minimizedTextContent=r,this._minimized=!o,this._isTabVisible=o,this._minimizedBeforeTabHide=!1,this.titleEl.addEventListener("dblclick",()=>this.toggleMinimized()),this._applyInitialTabVisibilityState(o),this._renderTitle()}isMinimized(){return this._minimized}isTabVisible(){return this._isTabVisible}toggleMinimized(){this.setMinimized(!this._minimized)}setMinimized(e){this._minimized!==e&&(this._minimized=e,e?this._handleMinimizeInternal():this._handleRestoreInternal())}setTabVisible(e){if(this._isTabVisible!==e){if(!e){this._minimizedBeforeTabHide=this._minimized,this.panelEl.classList.add("panel--tabHidden"),this.setMinimized(!0),this._isTabVisible=!1;return}this.panelEl.classList.remove("panel--tabHidden"),this._isTabVisible=!0,this.setMinimized(this._minimizedBeforeTabHide)}}_handleMinimizeInternal(){this.panelEl.classList.add("panel--minimized"),this._applyMinimizedSizing(),this._renderTitle(!0),this.pause()}_handleRestoreInternal(){this.panelEl.classList.remove("panel--minimized"),this._restoreSizing(),this._renderTitle(!1),this.resume()}_applyInitialTabVisibilityState(e){if(e){this.panelEl.classList.remove("panel--tabHidden"),this.panelEl.classList.remove("panel--minimized"),this._restoreSizing();return}this.panelEl.classList.add("panel--tabHidden"),this.panelEl.classList.add("panel--minimized"),this._applyMinimizedSizing()}_renderTitle(e=this._minimized){if(!e){this.titleEl.textContent=this.title;return}const t=this.title.slice(0,3),i=this.minimizedTextContent===""?t:this.minimizedTextContent;this.titleEl.textContent=i}_applyMinimizedSizing(){this.panelEl.style.width="auto",this.panelEl.style.height="auto",this.panelEl.style.minWidth="0",this.panelEl.style.minHeight="0"}_restoreSizing(){this.panelEl.style.width=this.baseSizing.width,this.panelEl.style.height=this.baseSizing.height,this.panelEl.style.minWidth=this.baseSizing.minWidth,this.panelEl.style.minHeight=this.baseSizing.minHeight}}class ne extends L{constructor(e,t,i,s){if(super(e),!(t instanceof HTMLElement))throw new Error("ExportCsvWidget requires a container element.");if(!i||typeof i.subscribe!="function")throw new Error("ExportCsvWidget requires a bus with subscribe(cb)->unsubscribe.");if(!s||typeof s.subscribe!="function")throw new Error("ExportCsvWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=s,this.container=t,this._log=[];const r=document.createElement("div");r.className="exportButtons";const o=document.createElement("button");o.type="button",o.textContent="Clear log",o.addEventListener("click",()=>this.clear());const a=document.createElement("button");a.type="button",a.textContent="Download to CSV",a.addEventListener("click",()=>this.downloadCsv()),r.appendChild(o),r.appendChild(a),t.appendChild(r);const l=document.createElement("div");l.className="exportCounterRow";const c=document.createElement("span");c.className="exportCounterLabel",c.textContent="Currently logged data points:";const d=document.createElement("span");d.className="exportCounterValue",d.textContent="0",l.appendChild(c),l.appendChild(d),t.appendChild(l),this._counterValue=d,this._unsubscribe=i.subscribe(h=>this.handle(h)),this.isTabVisible()&&this.resume()}container;_log;_scheduler;_unsubscribe;_unsubscribeTick;_counterValue;pause(){this._unsubscribeTick&&(this._unsubscribeTick(),this._unsubscribeTick=void 0)}resume(){this._unsubscribeTick||(this._unsubscribeTick=this._scheduler.subscribe(u.Hz1,()=>this.updateCounter()))}destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeTick&&this._unsubscribeTick()}clear(){this._log.length=0,this.updateCounter()}handle(e){if(e.CommandBytes[0]!==128)return;const t=[...e.CommandBytes,...e.floatValues,...e.intValues];this._log.push(t)}updateCounter(){this._counterValue&&(this._counterValue.textContent=`${this._log.length}`)}downloadCsv(){const t=[...Array.from({length:4},(l,c)=>`cmd${c}`),...Array.from({length:15},(l,c)=>`f${c+1}`),...Array.from({length:15},(l,c)=>`i${c+1}`)].join(","),i=this._log.map(l=>l.join(",")),s=[t,...i].join(`
`),r=new Blob([s],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download=`hid-reports-${Date.now()}.csv`,a.click(),URL.revokeObjectURL(o)}}class re extends L{constructor(e,t,i,s,r={}){if(super(e),!(t instanceof HTMLTextAreaElement))throw new Error("LogWidget requires a textarea element.");if(!i||typeof i.subscribe!="function")throw new Error("LogWidget requires a bus with subscribe(cb)->unsubscribe.");if(!s||typeof s.subscribe!="function")throw new Error("LogWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=s,this.el=t,this.maxLines=r.maxLines??1e3,this.formatter=r.formatter??(o=>`${o.floatValues[0]} ${o.floatValues[1]} ${o.floatValues[2]} ${o.floatValues[3]}`),this.updateRate=r.updateRate??u.Hz25,this._lines=new F(this.maxLines),this._unsubscribe=i.subscribe(o=>this.handle(o)),this.isTabVisible()&&this.resume()}el;maxLines;formatter;updateRate;_lines;_scheduler;_unsubscribe;_unsubscribeTick;pause(){this._unsubscribeTick&&(this._unsubscribeTick(),this._unsubscribeTick=void 0)}resume(){this._unsubscribeTick||(this._unsubscribeTick=this._scheduler.subscribe(this.updateRate,()=>this.flush()))}destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeTick&&this._unsubscribeTick()}clear(){this.el.value="",this._lines.clear()}handle(e){if(e.CommandBytes[0]!==128)return;const t=this.formatter(e);this._lines.push(t)}flush(){if(this._lines.size()===0)return;const e=[];this._lines.forEachInOrder(t=>e.push(t)),this.el.value=e.length?`${e.join(`
`)}
`:"",this.el.scrollTop=this.el.scrollHeight}}const N=4;function b(n){if(!Number.isFinite(n))return"";const e=Math.abs(n);return e!==0&&(e>=1e4||e<.001)?n.toExponential(N-1):n.toPrecision(N)}class oe extends L{constructor(e,t,i,s,r={}){if(super(e),!(t instanceof HTMLElement))throw new Error("PlotWidget requires a container element.");if(!i||typeof i.subscribe!="function")throw new Error("PlotWidget requires a bus with subscribe(cb)->unsubscribe.");if(!s||typeof s.subscribe!="function")throw new Error("PlotWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=s,t.classList.add("plotStack"),this.container=t,this.axesLayer=this._createLayer("axes",1),this.traceLayer=this._createLayer("trace",2),this.valueSelector=r.valueSelector??(o=>o.floatValues[0]),this.maxPoints=r.maxPoints??1e3,this.padding=r.padding??100,this.updateRate=r.updateRate??u.Hz25,this.axesUpdateRate=r.axesUpdateRate??u.Hz5,this.traceUpdateRate=r.traceUpdateRate??this.updateRate,this.label=r.label??"",this.buf=new F(this.maxPoints),this._unsubscribe=i.subscribe(o=>this.handle(o)),this.isTabVisible()&&this.resume(),this._boundOnResize=()=>{this.drawAxes(),this.drawTrace()},window.addEventListener("resize",this._boundOnResize),this.drawAxes(),this.drawTrace()}container;axesLayer;traceLayer;valueSelector;maxPoints;padding;updateRate;axesUpdateRate;traceUpdateRate;label;buf;_unsubscribe;_scheduler;_unsubscribeAxesTick;_unsubscribeTraceTick;_bounds;_boundOnResize;destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeAxesTick&&this._unsubscribeAxesTick(),this._unsubscribeTraceTick&&this._unsubscribeTraceTick(),this._boundOnResize&&window.removeEventListener("resize",this._boundOnResize)}clear(){this.buf.clear(),this.drawAxes(),this.drawTrace()}pause(){this._unsubscribeAxesTick&&(this._unsubscribeAxesTick(),this._unsubscribeAxesTick=void 0),this._unsubscribeTraceTick&&(this._unsubscribeTraceTick(),this._unsubscribeTraceTick=void 0)}resume(){this._unsubscribeAxesTick||(this._unsubscribeAxesTick=this._scheduler.subscribe(this.axesUpdateRate,()=>this.drawAxes())),this._unsubscribeTraceTick||(this._unsubscribeTraceTick=this._scheduler.subscribe(this.traceUpdateRate,()=>this.drawTrace()))}handle(e){if(e.CommandBytes[0]!==128)return;const t=this.valueSelector(e);Number.isFinite(t)&&this.buf.push(t)}_resizeLayersToDisplaySize(){const e=window.devicePixelRatio||1,t=this.container.getBoundingClientRect(),i=Math.max(1,Math.floor(t.width*e)),s=Math.max(1,Math.floor(t.height*e));for(const r of[this.axesLayer,this.traceLayer])(r.canvas.width!==i||r.canvas.height!==s)&&(r.canvas.width=i,r.canvas.height=s)}_getLayout(e,t){const a=Math.max(1,e-56-10),l=Math.max(1,t-10-24);return{left:56,right:10,top:10,bottom:24,plotW:a,plotH:l}}_computeBounds(){if(this.buf.size()===0)return null;let e=1/0,t=-1/0;this.buf.forEachInOrder(r=>{r<e&&(e=r),r>t&&(t=r)});let i=e-this.padding,s=t+this.padding;return(!Number.isFinite(i)||!Number.isFinite(s)||i===s)&&(i=-1,s=1),i>0&&(i=0),s<0&&(s=0),{yMin:i,yMax:s}}drawAxes(){this._resizeLayersToDisplaySize();const e=this.axesLayer.ctx,t=this.axesLayer.canvas.width,i=this.axesLayer.canvas.height,s=this._getThemeColors();if(e.clearRect(0,0,t,i),e.strokeStyle=s.axis,e.fillStyle=s.text,this.buf.size()===0){e.fillText("Not Connected",10,20),this._bounds=void 0;return}const r=this._computeBounds();if(!r){this._bounds=void 0;return}this._bounds=r;const{left:o,top:a,plotW:l,plotH:c}=this._getLayout(t,i);e.beginPath(),e.moveTo(o,a),e.lineTo(o,a+c),e.lineTo(o+l,a+c),e.stroke();const d=21,h=5,p=new Set;for(let m=0;m<h;m+=1){const w=Math.round(m*(d-1)/(h-1));p.add(w)}e.textAlign="right",e.textBaseline="middle";for(let m=0;m<d;m+=1){const w=m/(d-1),v=a+(1-w)*c,f=r.yMin+w*(r.yMax-r.yMin);e.beginPath(),e.moveTo(o-6,v),e.lineTo(o,v),e.stroke(),p.has(m)&&e.fillText(b(f),o-8,v)}}drawTrace(){this._resizeLayersToDisplaySize();const e=this.traceLayer.ctx,t=this.traceLayer.canvas.width,i=this.traceLayer.canvas.height,s=this._getThemeColors();if(e.clearRect(0,0,t,i),e.strokeStyle=s.trace,e.fillStyle=s.text,this.buf.size()===0)return;const r=this._bounds??this._computeBounds();if(!r)return;const{left:o,top:a,plotW:l,plotH:c}=this._getLayout(t,i),d=this.buf.size(),h=Math.max(1,d-1),p=f=>o+f/h*l,m=f=>{const z=(f-r.yMin)/(r.yMax-r.yMin);return a+(1-z)*c};e.beginPath();let w=!0;this.buf.forEachInOrder((f,z)=>{const H=p(z),k=m(f);w?(e.moveTo(H,k),w=!1):e.lineTo(H,k)}),e.stroke();const v=this.buf.latest();if(typeof v=="number"){const f=this.label?`${this.label} `:"";e.fillText(`Current ${f}: ${b(v)}`,o+6,i-6)}}_createLayer(e,t){const i=document.createElement("canvas");i.className="plotLayer",i.dataset.layer=e,i.style.zIndex=String(t),this.container.appendChild(i);const s=i.getContext("2d");if(!s)throw new Error("PlotWidget requires a 2D rendering context.");return{name:e,canvas:i,ctx:s}}_getThemeColors(){const e=getComputedStyle(this.container),t=(i,s)=>e.getPropertyValue(i).trim()||s;return{text:t("--color-text","#e4edf5"),axis:t("--color-muted","#9fb1c5"),trace:t("--color-accent","#5aa4ff")}}}function ae(n){if(n.length!==64)throw new Error(`Report ${n.commandId} must be exactly 64 bytes.`);const e=[...n.fields].sort((t,i)=>t.offset-i.offset);for(const t of e){if(t.offset<4||t.offset>60)throw new Error(`Field ${t.name} in report ${n.commandId} must be in byte range [4, 60].`);if(t.offset%4!==0)throw new Error(`Field ${t.name} in report ${n.commandId} must be 4-byte aligned.`);if(t.type!=="f32"&&t.type!=="i32")throw new Error(`Field ${t.name} in report ${n.commandId} has unsupported type ${String(t.type)}.`)}for(let t=1;t<e.length;t+=1){const i=e[t-1],s=e[t],r=i.offset+4;if(s.offset<r)throw new Error(`Fields ${i.name} and ${s.name} overlap in report ${n.commandId}.`)}}function le(n){return{name:n.name,label:n.label,offset:n.offset,type:n.type,parser:n.type==="f32"?"float":"int",readOnly:n.readOnly??!1,units:n.units??"",default:n.default,min:n.min,max:n.max,step:n.step,placeholder:n.placeholder,uiOrder:n.uiOrder,widgetMeta:n.widgetMeta}}function ce(n){return ae(n),n.fields.map(e=>le(e)).sort((e,t)=>{const i=e.uiOrder,s=t.uiOrder;if(typeof i=="number"||typeof s=="number"){const r=typeof i=="number"?i:Number.MAX_SAFE_INTEGER,o=typeof s=="number"?s:Number.MAX_SAFE_INTEGER;if(r!==o)return r-o}return e.offset-t.offset})}function A(n,e){const t=n.widgetMeta?.constraintsByProfile;if(!t)return{min:n.min,max:n.max};const i=t[_],s=t[e];return{min:s?.min??i?.min??n.min,max:s?.max??i?.max??n.max}}function de(n,e){let t=n;return typeof e.min=="number"&&t<e.min&&(t=e.min),typeof e.max=="number"&&t>e.max&&(t=e.max),t}function ue(n,e){return n.parser==="int"?/^-?\d+$/.test(e):/^-?(?:\d+\.?\d*|\.\d+)(?:[eE][+-]?\d+)?$/.test(e)}function he(n,e){return Number.isFinite(e)?n.parser!=="int"?!0:Number.isInteger(e)&&e>=-2147483648&&e<=2147483647:!1}function me(n,e,t){const i=t.trim();if(i.length===0||!ue(n,i))return{isAccepted:!1,normalizedValue:"",shouldShowTooltip:!0,wasClipped:!1};const s=n.parser==="float"?Number.parseFloat(i):Number.parseInt(i,10);if(!he(n,s))return{isAccepted:!1,normalizedValue:"",shouldShowTooltip:!0,wasClipped:!1};const r=de(s,e),o=n.parser==="int"?`${Math.trunc(r)}`:b(r),a=r!==s;return{isAccepted:!0,normalizedValue:o,shouldShowTooltip:a,wasClipped:a}}function $(n,e){return n.parser==="int"?`${Math.trunc(e)}`:`${Number(e.toPrecision(3))}`}function I(n,e){const t=typeof e.min=="number"?$(n,e.min):"-∞",i=typeof e.max=="number"?$(n,e.max):"+∞",s=n.parser==="int"?"integer":"float";return`${n.label} must be ${s} between ${t} and ${i}.`}class pe extends L{txBus;panelConfig;reportSpec;fieldBindings;errorEl;receivedDataEl;_unsubscribeReport;_unsubscribeDeviceProfile;activeProfileCode=_;constructor(e,t,i,s,r,o){if(super(e),!t||typeof t.publish!="function")throw new Error("CommandPanelWidget requires a command bus with publish().");if(!i||typeof i.subscribe!="function")throw new Error("CommandPanelWidget requires a report bus with subscribe().");if(!s||typeof s.subscribe!="function")throw new Error("CommandPanelWidget requires a device profile bus with subscribe().");this.txBus=t,this.panelConfig=r,this.reportSpec=o,this.fieldBindings=[],this.errorEl=document.createElement("div"),this.errorEl.className="commandPanelError",this.errorEl.textContent="",this.receivedDataEl=document.createElement("div"),this.receivedDataEl.className="commandPanelReceived",this.receivedDataEl.textContent="Data Received:",this.render(e.bodyEl),this._unsubscribeReport=i.subscribe(a=>this.handleReport(a)),this._unsubscribeDeviceProfile=s.subscribe(a=>this.handleDeviceProfile(a))}pause(){}resume(){}destroy(){this._unsubscribeReport&&this._unsubscribeReport(),this._unsubscribeDeviceProfile&&this._unsubscribeDeviceProfile();for(const e of this.fieldBindings)this.clearTooltipTimers(e);this.fieldBindings.length=0}render(e){e.innerHTML="";const t=document.createElement("div");t.className="commandPanelFields";for(const s of ce(this.reportSpec)){const r=document.createElement("label");r.className="commandPanelRow",r.htmlFor=this.inputId(s.name);const o=document.createElement("span");o.className="commandPanelFieldLabel",o.textContent=s.label;const a=document.createElement("span");a.className="commandPanelInputWrap";const l=document.createElement("input");l.className="commandPanelInput",l.id=this.inputId(s.name),l.type="text",l.readOnly=s.readOnly,s.placeholder&&(l.placeholder=s.placeholder);const c=typeof s.default=="number"?s.default:0;l.value=s.parser==="int"?`${Math.trunc(c)}`:b(c),typeof s.step=="number"&&(l.step=`${s.step}`);const d=document.createElement("span");d.className="commandPanelUnits",d.textContent=s.units;const h=document.createElement("span");h.className="commandPanelTooltip",h.setAttribute("role","status"),h.setAttribute("aria-live","polite");const p={spec:s,input:l,tooltipEl:h,lastValidValue:l.value,constraints:A(s,this.activeProfileCode)};this.applyInputConstraints(p),l.addEventListener("keydown",m=>this.handleFieldKeydown(m,p)),l.addEventListener("blur",()=>this.enforceCommittedFieldValue(p)),l.addEventListener("mouseenter",()=>this.scheduleHoverTooltip(p)),l.addEventListener("mouseleave",()=>this.clearHoverTimer(p)),a.appendChild(l),a.appendChild(h),r.appendChild(o),r.appendChild(a),r.appendChild(d),t.appendChild(r),this.fieldBindings.push(p)}const i=document.createElement("button");i.className="commandPanelSend",i.type="button",i.textContent=this.panelConfig.buttonLabel??this.reportSpec.widgetUi?.buttonLabel??"Send",i.addEventListener("click",()=>this.handleSend()),e.appendChild(t),e.appendChild(i),e.appendChild(this.errorEl),e.appendChild(this.receivedDataEl)}handleDeviceProfile(e){this.activeProfileCode=e;for(const t of this.fieldBindings)t.constraints=A(t.spec,this.activeProfileCode),this.applyInputConstraints(t),this.enforceCommittedFieldValue(t)}applyInputConstraints(e){typeof e.constraints.min=="number"?e.input.min=`${e.constraints.min}`:e.input.removeAttribute("min"),typeof e.constraints.max=="number"?e.input.max=`${e.constraints.max}`:e.input.removeAttribute("max")}handleReport(e){if(e.CommandBytes[0]!==this.panelConfig.commandId)return;const t=new DataView(e.rawBytes.buffer,e.rawBytes.byteOffset,e.rawBytes.byteLength),i=[];for(const s of this.fieldBindings){const r=s.spec.type==="f32"?t.getFloat32(s.spec.offset,!0):t.getInt32(s.spec.offset,!0);s.input.value=s.spec.parser==="int"?`${Math.trunc(r)}`:b(r),s.lastValidValue=s.input.value;const o=s.spec.type==="f32"?r.toPrecision(3):`${r}`;i.push(o)}this.receivedDataEl.textContent=`Data Received: ${i.join(", ")}`}handleFieldKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),this.enforceCommittedFieldValue(t),t.input.blur())}enforceCommittedFieldValue(e){const t=me(e.spec,e.constraints,e.input.value);if(!t.isAccepted){e.input.value=e.lastValidValue,t.shouldShowTooltip&&this.showTooltip(e,I(e.spec,e.constraints));return}e.input.value=t.normalizedValue,e.lastValidValue=t.normalizedValue,t.shouldShowTooltip&&this.showTooltip(e,I(e.spec,e.constraints))}scheduleHoverTooltip(e){this.clearHoverTimer(e),e.hoverTimerId=window.setTimeout(()=>{this.showTooltip(e,I(e.spec,e.constraints)),e.hoverTimerId=void 0},1e3)}clearHoverTimer(e){typeof e.hoverTimerId=="number"&&window.clearTimeout(e.hoverTimerId),e.hoverTimerId=void 0}showTooltip(e,t){this.clearTooltipTimers(e),e.tooltipEl.textContent=t,e.tooltipEl.classList.add("commandPanelTooltip--visible"),e.tooltipEl.classList.remove("commandPanelTooltip--fading"),e.fadeTimerId=window.setTimeout(()=>{e.tooltipEl.classList.add("commandPanelTooltip--fading")},2e3),e.hideTimerId=window.setTimeout(()=>{e.tooltipEl.classList.remove("commandPanelTooltip--visible","commandPanelTooltip--fading")},3e3)}clearTooltipTimers(e){this.clearHoverTimer(e),typeof e.fadeTimerId=="number"&&window.clearTimeout(e.fadeTimerId),typeof e.hideTimerId=="number"&&window.clearTimeout(e.hideTimerId),e.fadeTimerId=void 0,e.hideTimerId=void 0}handleSend(){this.clearError(),this.clearInputErrors();const e=new Uint8Array(64);e[0]=this.panelConfig.commandId;const t=new DataView(e.buffer);for(const i of this.fieldBindings){if(i.spec.readOnly)continue;const s=i.input.value.trim(),r=i.spec.parser==="float"?Number.parseFloat(s):Number.parseInt(s,10);if(!Number.isFinite(r)){this.setFieldError(i.input,`${i.spec.label} is not a valid number.`);return}if(i.spec.parser==="int"&&(!Number.isInteger(r)||r<-2147483648||r>2147483647)){this.setFieldError(i.input,`${i.spec.label} must be a valid int32 value.`);return}if(typeof i.constraints.min=="number"&&r<i.constraints.min){this.setFieldError(i.input,`${i.spec.label} must be >= ${i.constraints.min}.`);return}if(typeof i.constraints.max=="number"&&r>i.constraints.max){this.setFieldError(i.input,`${i.spec.label} must be <= ${i.constraints.max}.`);return}i.spec.type==="f32"?t.setFloat32(i.spec.offset,r,!0):t.setInt32(i.spec.offset,r,!0)}this.txBus.publish({type:"hid_send",commandId:this.panelConfig.commandId,bytes:e,length:64,timestampMs:performance.now()})}inputId(e){return`cmd-${this.panelConfig.commandId}-${e}`}setFieldError(e,t){e.classList.add("commandPanelInput--error"),this.errorEl.textContent=t}clearInputErrors(){for(const e of this.fieldBindings)e.input.classList.remove("commandPanelInput--error")}clearError(){this.errorEl.textContent=""}}const y=34028234663852886e22,g=-y,fe=2147483647,be=-2147483648,_e={2:{commandId:2,name:"Auto Characterize",length:64,widgetUi:{buttonLabel:"Characterize",instantiateGenericCommandWidget:!0},fields:[{name:"resistance",label:"Resistance",offset:4,type:"f32",endian:"le",units:"Ohms",widgetMeta:{constraintsByProfile:{0:{min:g,max:y}}}},{name:"ld",label:"Ld",offset:8,type:"f32",endian:"le",units:"Henries",widgetMeta:{constraintsByProfile:{0:{min:g,max:y}}}},{name:"lq",label:"Lq",offset:12,type:"f32",endian:"le",units:"Henries",widgetMeta:{constraintsByProfile:{0:{min:g,max:y}}}},{name:"fluxLinkage",label:"Flux Linkage",offset:16,type:"f32",endian:"le",units:"Weber",widgetMeta:{constraintsByProfile:{0:{min:g,max:y}}}},{name:"statusCode",label:"Status Code",offset:20,type:"i32",endian:"le",units:"",widgetMeta:{constraintsByProfile:{0:{min:be,max:fe}}}}]},4:{commandId:4,name:"Power Config",length:64,widgetUi:{buttonLabel:"Set Power Limits",instantiateGenericCommandWidget:!0},fields:[{name:"motorCurrent",label:"Motor Current",offset:4,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:g,max:y},22288:{min:0,max:40}}}},{name:"batteryCurrentDischarge",label:"Battery Current Discharge",offset:8,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:g,max:y},22288:{min:0,max:40}}}},{name:"batteryCurrentRegen",label:"Battery Current Regen",offset:12,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:g,max:y},22288:{min:0,max:40}}}}]}},U=document.getElementById("dashboard");if(!U)throw new Error("Missing required UI elements.");const ye=U,we=()=>{const n=document.createElement("div");n.className="topbar dashboardControls";const e=document.createElement("div");e.className="topbarLeft";const t=document.createElement("div");t.className="topbarCenter";const i=document.createElement("div");i.className="topbarRight";const s=document.createElement("button");s.id="connectBtn",s.textContent="Connect HID";const r=document.createElement("div");r.className="topbarGroup",r.append(s);const o=document.createElement("div");o.id="status",o.className="status",o.textContent="Disconnected";const a=document.createElement("a");return a.className="topbarLink",a.href=new URL("one-pager/",window.location.href).toString(),a.textContent="Chiralight Advantage",a.target="_blank",a.rel="noreferrer",a.title="Opens in New Tab",r.append(o),e.append(r),t.append(a),n.append(e,t,i),{headerEl:n,connectBtn:s,statusEl:o,rightSlotEl:i}},{headerEl:ge,connectBtn:ve,statusEl:Ce}=we(),x=document.createElement("nav");x.id="tabs";x.className="tabs";x.setAttribute("aria-label","Dashboard tabs");const R=document.createElement("div");R.className="dashboardPanels";ye.append(ge,x,R);const W=ve,V=Ce,D=x,O=R,E=new K,q=new J,S=new Y,G=new te,C=new ie({bus:E,commandBus:q,deviceProfileBus:G}),j=[{id:"realtime",label:"Realtime Data"},{id:"configuration",label:"Configuration"},{id:"firmware",label:"Firmware Update"}],Ee=[{tab:"realtime",pos:70,kind:"log",title:"Log (all floats)",hint:"1 report per line",minimizedTextContent:"Log",size:{w:520,h:260},log:{maxLines:1e3,formatter:n=>`${b(n.floatValues[0])} ${b(n.floatValues[1])} ${b(n.floatValues[2])} ${b(n.floatValues[3])}`,updateRate:u.Hz10}},{tab:"realtime",pos:20,kind:"plot",title:"Motor Speed (rad/s)",hint:"Motor Speed in radians per second",minimizedTextContent:"Mtr Spd",size:{w:520,h:320},plot:{valueSelector:n=>n.floatValues[0],maxPoints:1e3,padding:100,traceUpdateRate:u.Hz25,axesUpdateRate:u.Hz10,label:"Motor Speed"}},{tab:"realtime",pos:30,kind:"plot",title:"Motor Current (A)",hint:"Motor Current in Amperes",minimizedTextContent:"Mtr Cur",size:{w:520,h:320},plot:{valueSelector:n=>n.floatValues[1],maxPoints:1e3,padding:1,traceUpdateRate:u.Hz25,axesUpdateRate:u.Hz10,label:"Motor Current"}},{tab:"realtime",pos:100,kind:"export",title:"Export CSV",hint:"Lossless log from 64-byte reports",minimizedTextContent:"CSV",size:{w:420,h:200}},{tab:"realtime",pos:40,kind:"plot",title:"Battery Voltage (V)",hint:"DC Link Voltage in Volts",minimizedTextContent:"Bat Vlt",size:{w:520,h:320},plot:{valueSelector:n=>n.floatValues[2],maxPoints:1e3,padding:10,traceUpdateRate:u.Hz25,axesUpdateRate:u.Hz10,label:"Battery Voltage"}},{tab:"realtime",pos:50,kind:"plot",title:"Battery Current (A)",hint:"DC Link Current in Ampere",minimizedTextContent:"Bat Cur",size:{w:520,h:320},plot:{valueSelector:n=>n.floatValues[3],maxPoints:1e3,padding:1,traceUpdateRate:u.Hz25,axesUpdateRate:u.Hz10,label:"Battery Current"}},{tab:"configuration",pos:20,kind:"command",title:"Automatic Characterization",hint:"ReportSpec command 2",minimizedTextContent:"Auto Char",size:{w:520,h:340},command:{commandId:2}},{tab:"configuration",pos:30,kind:"command",title:"Power Configuration",hint:"ReportSpec command 4",minimizedTextContent:"Power Cfg",size:{w:520,h:340},command:{commandId:4}}],B=[],M=new Map;let T=j[0].id;function Te(){O.innerHTML="",B.length=0,M.clear();const n=[...Ee].sort((e,t)=>e.pos-t.pos);for(const e of n){const{panel:t,body:i,titleEl:s}=se(e),r={panelEl:t,bodyEl:i,titleEl:s,title:e.title,minimizedTextContent:e.minimizedTextContent??"",initialTabVisible:e.tab===T};let o=null;if(e.kind==="log"){const a=document.createElement("textarea");a.className="log",a.placeholder="Reports...",a.readOnly=!0,i.appendChild(a),o=new re(r,a,E,S,e.log)}else if(e.kind==="plot"){const a=document.createElement("div");a.className="plotStack",i.appendChild(a),o=new oe(r,a,E,S,e.plot)}else if(e.kind==="export"){const a=document.createElement("div");i.appendChild(a),o=new ne(r,a,E,S)}else if(e.kind==="command"){const a=_e[e.command.commandId];if(!a)throw new Error(`Missing report spec for commandId ${e.command.commandId}.`);if(a.widgetUi?.instantiateGenericCommandWidget===!1)continue;o=new pe(r,q,E,G,e.command,a)}O.appendChild(t),o&&(B.push(o),M.set(o,e.tab))}}Te();X();function X(){D.innerHTML="";for(const n of j){const e=document.createElement("button");e.type="button",e.className="tabButton",e.textContent=n.label,e.dataset.tabId=n.id;const t=n.id===T;e.classList.toggle("tabButton--active",t),e.setAttribute("aria-selected",String(t)),e.setAttribute("role","tab"),e.addEventListener("click",()=>xe(n.id)),D.appendChild(e)}}function xe(n){if(T!==n){T=n;for(const e of B){const t=M.get(e);t&&e.setTabVisible(t===T)}X()}}C.onStatus(n=>{V.textContent=n,W.textContent=C.isConnected()?"Disconnect HID":"Connect HID"});W.addEventListener("click",async()=>{if(!C.isSupported()){V.textContent="WebHID not supported in this browser.";return}try{C.isConnected()?await C.disconnect():await C.connect()}catch(n){V.textContent=`Error: ${n instanceof Error?n.message:String(n)}`}});
