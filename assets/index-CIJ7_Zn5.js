(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class le{_subs=new Set;subscribe(e){return this._subs.add(e),()=>this._subs.delete(e)}publish(e){for(const t of this._subs)t(e)}clear(){this._subs.clear()}}class ue{_subs=new Set;subscribe(e){return this._subs.add(e),()=>this._subs.delete(e)}publish(e){for(const t of this._subs)t(e)}clear(){this._subs.clear()}}var E=(r=>(r.Hz25="25Hz",r.Hz10="10Hz",r.Hz5="5Hz",r.Hz1="1Hz",r))(E||{});const de={"25Hz":1e3/25,"10Hz":1e3/10,"5Hz":1e3/5,"1Hz":1e3/1};class he{_subs=new Map;_timers=new Map;_active=!0;constructor(){for(const e of Object.values(E))this._subs.set(e,new Set);this._active=!document.hidden,this._toggleTimers(this._active),document.addEventListener("visibilitychange",()=>{this._active=!document.hidden,this._toggleTimers(this._active)})}subscribe(e,t){const s=this._subs.get(e);if(!s)throw new Error(`Unknown scheduler rate: ${e}`);return s.add(t),this._active&&this._ensureTimer(e),()=>{s.delete(t),s.size===0&&this._clearTimer(e)}}_ensureTimer(e){if(this._timers.has(e))return;const t=window.setInterval(()=>{const s=this._subs.get(e);if(!(!s||s.size===0))for(const i of s)i()},de[e]);this._timers.set(e,t)}_clearTimer(e){const t=this._timers.get(e);t&&(clearInterval(t),this._timers.delete(e))}_toggleTimers(e){if(!e){for(const t of this._timers.values())clearInterval(t);this._timers.clear();return}for(const[t,s]of this._subs.entries())s.size!==0&&this._ensureTimer(t)}}const _="0",me=[{vendorId:1155,productId:22288,profileCode:"22288"}];function F(r){if(r==null)return _;const e=String(r).trim();return e.length>0?e:_}function pe(r){if(!r)return _;for(const e of me)if(!(typeof e.vendorId=="number"&&r.vendorId!==e.vendorId)&&!(typeof e.productId=="number"&&r.productId!==e.productId)&&!(typeof e.productNameIncludes=="string"&&!(r.productName??"").toLowerCase().includes(e.productNameIncludes.toLowerCase())))return F(e.profileCode);return F(r.productId)}class fe{subscribers=new Set;currentProfileCode=_;subscribe(e){return this.subscribers.add(e),e(this.currentProfileCode),()=>this.subscribers.delete(e)}publish(e){this.currentProfileCode=F(e);for(const t of this.subscribers)t(this.currentProfileCode)}clear(){this.publish(_)}}var L=(r=>(r[r.REALTIME_DATA_COMMAND=128]="REALTIME_DATA_COMMAND",r))(L||{});const w=64,$=4,q=4,H=(w-$)/q;function Q(r){const e=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),t=new Uint8Array(w);return t.set(e.subarray(0,w)),t}function Z(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength),t=[],s=[];for(let i=0;i<H;i+=1){const n=$+i*q;t.push(e.getFloat32(n,!0)),s.push(e.getInt32(n,!0))}return{floatValues:t,intValues:s}}const v=34028234663852886e22,T=-v,be=2147483647,ye=-2147483648,_e={2:{commandId:2,name:"Auto Characterize",length:w,widgetUi:{buttonLabel:"Characterize",instantiateGenericCommandWidget:!0},fields:[{name:"resistance",label:"Resistance",offset:4,type:"f32",endian:"le",units:"Ohms",widgetMeta:{constraintsByProfile:{0:{min:T,max:v}}}},{name:"ld",label:"Ld",offset:8,type:"f32",endian:"le",units:"Henries",widgetMeta:{constraintsByProfile:{0:{min:T,max:v}}}},{name:"lq",label:"Lq",offset:12,type:"f32",endian:"le",units:"Henries",widgetMeta:{constraintsByProfile:{0:{min:T,max:v}}}},{name:"fluxLinkage",label:"Flux Linkage",offset:16,type:"f32",endian:"le",units:"Weber",widgetMeta:{constraintsByProfile:{0:{min:T,max:v}}}},{name:"statusCode",label:"Status Code",offset:20,type:"i32",endian:"le",units:"",widgetMeta:{constraintsByProfile:{0:{min:ye,max:be}}}}]},4:{commandId:4,name:"Power Config",length:w,widgetUi:{buttonLabel:"Set Power Limits",instantiateGenericCommandWidget:!0},fields:[{name:"motorCurrent",label:"Motor Current",offset:4,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:T,max:v},22288:{min:0,max:40}}}},{name:"batteryCurrentDischarge",label:"Battery Current Discharge",offset:8,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:T,max:v},22288:{min:0,max:40}}}},{name:"batteryCurrentRegen",label:"Battery Current Regen",offset:12,type:"f32",endian:"le",units:"Ampere",widgetMeta:{constraintsByProfile:{0:{min:T,max:v},22288:{min:0,max:40}}}}]}};class we{constructor(e){if(!e?.bus||typeof e.bus.publish!="function")throw new Error("HIDClient requires a bus with a publish(report) method.");this.bus=e.bus,this.commandBus=e.commandBus,this.filters=e.filters??[{vendorId:1155,productId:22288}],this.deviceProfileBus=e.deviceProfileBus,this.device=null,this.statusListeners=new Set,this._boundOnInputReport=this._onInputReport.bind(this),this._boundOnDisconnect=this._onDisconnect.bind(this),this._boundOnCommand=this._onCommand.bind(this),this.commandBus&&(this._commandUnsubscribe=this.commandBus.subscribe(this._boundOnCommand))}bus;commandBus;deviceProfileBus;_commandUnsubscribe;filters;device;statusListeners;_boundOnInputReport;_boundOnDisconnect;_boundOnCommand;isSupported(){return"hid"in navigator}isConnected(){return!!this.device&&this.device.opened}onStatus(e){return this.statusListeners.add(e),e(this.isConnected()?"Connected":"Disconnected"),()=>this.statusListeners.delete(e)}_emitStatus(e){for(const t of this.statusListeners)t(e)}async connect(){if(!this.isSupported())throw new Error("WebHID is not supported in this browser.");this.device&&await this.disconnect(),this._emitStatus("Opening device chooser...");const e=await navigator.hid.requestDevice({filters:this.filters});if(!e||e.length===0){this._emitStatus("No device selected.");return}this.device=e[0],await this.device.open(),this.device.addEventListener("inputreport",this._boundOnInputReport),navigator.hid.addEventListener("disconnect",this._boundOnDisconnect),this.deviceProfileBus?.publish(pe(this.device)),this._emitStatus(`Connected: ${this.device.productName||"HID device"}`)}async disconnect(){if(!this.device){this.deviceProfileBus?.publish(_),this._emitStatus("Disconnected");return}try{this.device.removeEventListener("inputreport",this._boundOnInputReport),navigator.hid.removeEventListener("disconnect",this._boundOnDisconnect),this.device.opened&&await this.device.close()}finally{this.device=null,this.deviceProfileBus?.publish(_),this._emitStatus("Disconnected")}}_onDisconnect(e){this.device&&e.device===this.device&&this.disconnect().catch(()=>{})}async _onCommand(e){if(!this.device||!this.device.opened)return;const t=e.type==="hid_send"&&e.bytes instanceof Uint8Array,s=t?0:e.reportId,i=t?e.bytes:e.data;if(typeof s!="number"||!i){this._emitStatus("Send failed: invalid command payload.");return}try{await this.device.sendReport(s,i)}catch(n){this._emitStatus(`Send failed: ${n instanceof Error?n.message:String(n)}`)}}_onInputReport(e){const t=performance.now(),s=e.data,i=Q(s),n=[i[0],i[1],i[2],i[3]],{floatValues:o,intValues:a}=Z(i);this.bus.publish({reportId:e.reportId,timestampMs:t,device:this.device,CommandBytes:n,floatValues:o,intValues:a,byteLength:w,rawBytes:i})}}class ve{constructor(e){if(!e?.bus||typeof e.bus.publish!="function")throw new Error("HIDClientSim requires a bus with a publish(report) method.");this.bus=e.bus,this.commandBus=e.commandBus,this.commandBus&&(this._commandUnsubscribe=this.commandBus.subscribe(t=>this._onCommand(t)))}bus;commandBus;_commandUnsubscribe;_statusListeners=new Set;_streamTimer=null;_reportIndex=0;_connected=!1;isSupported(){return!0}isConnected(){return this._connected}onStatus(e){return this._statusListeners.add(e),e(this._connected?"Connected: HID Simulator":"Disconnected"),()=>this._statusListeners.delete(e)}async connect(){this._connected||(this._connected=!0,this._emitStatus("Connected: HID Simulator"),this._streamTimer=window.setInterval(()=>this._publishSineReport(),10))}async disconnect(){this._streamTimer!==null&&(window.clearInterval(this._streamTimer),this._streamTimer=null),this._connected=!1,this._emitStatus("Disconnected")}destroy(){this._commandUnsubscribe&&this._commandUnsubscribe(),this.disconnect()}_emitStatus(e){for(const t of this._statusListeners)t(e)}_publishSineReport(){if(!this._connected)return;const e=2*Math.PI*this._reportIndex/500,t=Math.sin(e),s=new Array(H).fill(t),i=s.map(n=>Math.round(n*1e3));this.bus.publish({reportId:0,timestampMs:performance.now(),device:null,CommandBytes:[128,0,0,0],floatValues:s,intValues:i,byteLength:w,rawBytes:this._encodeRawBytes(s)}),this._reportIndex+=1}_encodeRawBytes(e){const t=new Uint8Array(w);t[0]=128;const s=new DataView(t.buffer),i=Math.min(H,e.length);for(let n=0;n<i;n+=1)s.setFloat32($+n*q,e[n],!0);return t}_onCommand(e){if(!this._connected)return;const s=e.type==="hid_send"&&e.bytes instanceof Uint8Array?e.bytes:e.data instanceof Uint8Array?e.data:null;if(!s)return;const i=Q(s),{floatValues:n,intValues:o}=Z(i);this.bus.publish({reportId:0,timestampMs:performance.now(),device:null,CommandBytes:[i[0],i[1],i[2],i[3]],floatValues:n,intValues:o,byteLength:i.length,rawBytes:i})}}class ee{_buf;_head=0;_count=0;constructor(e){if(!Number.isInteger(e)||e<=0)throw new Error(`RingBuffer capacity must be a positive integer (received ${e}).`);this._buf=new Array(e)}capacity(){return this._buf.length}size(){return this._count}push(e){this._buf[this._head]=e,this._head=(this._head+1)%this.capacity(),this._count<this.capacity()&&(this._count+=1)}clear(){this._head=0,this._count=0}forEachInOrder(e){const t=(this._head-this._count+this.capacity())%this.capacity();for(let s=0;s<this._count;s+=1){const i=(t+s)%this.capacity();e(this._buf[i],s)}}latest(){if(this._count===0)return;const e=(this._head-1+this.capacity())%this.capacity();return this._buf[e]}}function Ee({title:r,hint:e,pos:t,size:s}){const i=document.createElement("section");i.className="panel",i.style.order=String(t),s?.w&&(i.style.width=`${s.w}px`),s?.h&&(i.style.height=`${s.h}px`);const n=document.createElement("div");n.className="panelHeader";const o=document.createElement("h2");o.className="panelTitle",o.textContent=r;const a=document.createElement("div");a.className="panelHint",a.textContent=e||"",n.appendChild(o),n.appendChild(a);const c=document.createElement("div");return c.className="panelBody",i.appendChild(n),i.appendChild(c),{panel:i,body:c,titleEl:o}}class M{panelEl;bodyEl;titleEl;baseSizing;title;minimizedTextContent;_minimized;_isTabVisible;_minimizedBeforeTabHide;constructor({panelEl:e,bodyEl:t,titleEl:s,title:i,minimizedTextContent:n="",initialTabVisible:o=!0}){if(!(e instanceof HTMLElement))throw new Error("PanelWidget requires a panel element.");if(!(t instanceof HTMLElement))throw new Error("PanelWidget requires a body element.");if(!(s instanceof HTMLElement))throw new Error("PanelWidget requires a title element.");this.panelEl=e,this.bodyEl=t,this.titleEl=s,this.baseSizing={width:e.style.width,height:e.style.height,minWidth:e.style.minWidth,minHeight:e.style.minHeight},this.title=i,this.minimizedTextContent=n,this._minimized=!o,this._isTabVisible=o,this._minimizedBeforeTabHide=!1,this.titleEl.addEventListener("dblclick",()=>this.toggleMinimized()),this._applyInitialTabVisibilityState(o),this._renderTitle()}isMinimized(){return this._minimized}isTabVisible(){return this._isTabVisible}toggleMinimized(){this.setMinimized(!this._minimized)}setMinimized(e){this._minimized!==e&&(this._minimized=e,e?this._handleMinimizeInternal():this._handleRestoreInternal())}setTabVisible(e){if(this._isTabVisible!==e){if(!e){this._minimizedBeforeTabHide=this._minimized,this.panelEl.classList.add("panel--tabHidden"),this.setMinimized(!0),this._isTabVisible=!1;return}this.panelEl.classList.remove("panel--tabHidden"),this._isTabVisible=!0,this.setMinimized(this._minimizedBeforeTabHide)}}_handleMinimizeInternal(){this.panelEl.classList.add("panel--minimized"),this._applyMinimizedSizing(),this._renderTitle(!0),this.pause()}_handleRestoreInternal(){this.panelEl.classList.remove("panel--minimized"),this._restoreSizing(),this._renderTitle(!1),this.resume()}_applyInitialTabVisibilityState(e){if(e){this.panelEl.classList.remove("panel--tabHidden"),this.panelEl.classList.remove("panel--minimized"),this._restoreSizing();return}this.panelEl.classList.add("panel--tabHidden"),this.panelEl.classList.add("panel--minimized"),this._applyMinimizedSizing()}_renderTitle(e=this._minimized){if(!e){this.titleEl.textContent=this.title;return}const t=this.title.slice(0,3),s=this.minimizedTextContent===""?t:this.minimizedTextContent;this.titleEl.textContent=s}_applyMinimizedSizing(){this.panelEl.style.width="auto",this.panelEl.style.height="auto",this.panelEl.style.minWidth="0",this.panelEl.style.minHeight="0"}_restoreSizing(){this.panelEl.style.width=this.baseSizing.width,this.panelEl.style.height=this.baseSizing.height,this.panelEl.style.minWidth=this.baseSizing.minWidth,this.panelEl.style.minHeight=this.baseSizing.minHeight}}class Te extends M{constructor(e,t,s,i){if(super(e),!(t instanceof HTMLElement))throw new Error("ExportCsvWidget requires a container element.");if(!s||typeof s.subscribe!="function")throw new Error("ExportCsvWidget requires a bus with subscribe(cb)->unsubscribe.");if(!i||typeof i.subscribe!="function")throw new Error("ExportCsvWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=i,this.container=t,this._log=[];const n=document.createElement("div");n.className="exportButtons";const o=document.createElement("button");o.type="button",o.textContent="Clear log",o.addEventListener("click",()=>this.clear());const a=document.createElement("button");a.type="button",a.textContent="Download to CSV",a.addEventListener("click",()=>this.downloadCsv()),n.appendChild(o),n.appendChild(a),t.appendChild(n);const c=document.createElement("div");c.className="exportCounterRow";const l=document.createElement("span");l.className="exportCounterLabel",l.textContent="Currently logged data points:";const u=document.createElement("span");u.className="exportCounterValue",u.textContent="0",c.appendChild(l),c.appendChild(u),t.appendChild(c),this._counterValue=u,this._unsubscribe=s.subscribe(h=>this.handle(h)),this.isTabVisible()&&this.resume()}container;_log;_scheduler;_unsubscribe;_unsubscribeTick;_counterValue;pause(){this._unsubscribeTick&&(this._unsubscribeTick(),this._unsubscribeTick=void 0)}resume(){this._unsubscribeTick||(this._unsubscribeTick=this._scheduler.subscribe(E.Hz1,()=>this.updateCounter()))}destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeTick&&this._unsubscribeTick()}clear(){this._log.length=0,this.updateCounter()}handle(e){if(e.CommandBytes[0]!==L.REALTIME_DATA_COMMAND)return;const t=[...e.CommandBytes,...e.floatValues,...e.intValues];this._log.push(t)}updateCounter(){this._counterValue&&(this._counterValue.textContent=`${this._log.length}`)}downloadCsv(){const t=[...Array.from({length:4},(c,l)=>`cmd${l}`),...Array.from({length:15},(c,l)=>`f${l+1}`),...Array.from({length:15},(c,l)=>`i${l+1}`)].join(","),s=this._log.map(c=>c.join(",")),i=[t,...s].join(`
`),n=new Blob([i],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`hid-reports-${Date.now()}.csv`,a.click(),URL.revokeObjectURL(o)}}class ge extends M{constructor(e,t,s,i,n={}){if(super(e),!(t instanceof HTMLTextAreaElement))throw new Error("LogWidget requires a textarea element.");if(!s||typeof s.subscribe!="function")throw new Error("LogWidget requires a bus with subscribe(cb)->unsubscribe.");if(!i||typeof i.subscribe!="function")throw new Error("LogWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=i,this.el=t,this.maxLines=n.maxLines??1e3,this.formatter=n.formatter??(o=>`${o.floatValues[0]} ${o.floatValues[1]} ${o.floatValues[2]} ${o.floatValues[3]}`),this.updateRate=n.updateRate??E.Hz25,this._lines=new ee(this.maxLines),this._unsubscribe=s.subscribe(o=>this.handle(o)),this.isTabVisible()&&this.resume()}el;maxLines;formatter;updateRate;_lines;_scheduler;_unsubscribe;_unsubscribeTick;pause(){this._unsubscribeTick&&(this._unsubscribeTick(),this._unsubscribeTick=void 0)}resume(){this._unsubscribeTick||(this._unsubscribeTick=this._scheduler.subscribe(this.updateRate,()=>this.flush()))}destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeTick&&this._unsubscribeTick()}clear(){this.el.value="",this._lines.clear()}handle(e){if(e.CommandBytes[0]!==L.REALTIME_DATA_COMMAND)return;const t=this.formatter(e);this._lines.push(t)}flush(){if(this._lines.size()===0)return;const e=[];this._lines.forEachInOrder(t=>e.push(t)),this.el.value=e.length?`${e.join(`
`)}
`:"",this.el.scrollTop=this.el.scrollHeight}}const te=-2147483648,se=2147483647,G=4;function y(r){if(!Number.isFinite(r))return"";const e=Math.abs(r);return e!==0&&(e>=1e4||e<.001)?r.toExponential(G-1):r.toPrecision(G)}function Ce(r,e){let t=r;return typeof e.min=="number"&&t<e.min&&(t=e.min),typeof e.max=="number"&&t>e.max&&(t=e.max),t}function xe(r,e){return r==="int"?/^-?\d+$/.test(e):/^-?(?:\d+\.?\d*|\.\d+)(?:[eE][+-]?\d+)?$/.test(e)}function Se(r,e){return Number.isFinite(e)?r!=="int"?!0:Number.isInteger(e)&&e>=te&&e<=se:!1}function ie(r){const{parser:e,constraints:t,rawText:s,formatFloat:i}=r,n=s.trim();if(n.length===0||!xe(e,n))return{isAccepted:!1,normalizedValue:"",shouldShowTooltip:!0,wasClipped:!1};const o=e==="float"?Number.parseFloat(n):Number.parseInt(n,10);if(!Se(e,o))return{isAccepted:!1,normalizedValue:"",shouldShowTooltip:!0,wasClipped:!1};const a=Ce(o,t);return{isAccepted:!0,normalizedValue:e==="int"?`${Math.trunc(a)}`:i(a),shouldShowTooltip:a!==o,wasClipped:a!==o}}function j(r,e){const t=r.widgetMeta?.constraintsByProfile;if(!t)return{min:r.min,max:r.max};const s=t[_],i=t[e];return{min:i?.min??s?.min??r.min,max:i?.max??s?.max??r.max}}class Ie extends M{constructor(e,t,s,i,n={}){if(super(e),!(t instanceof HTMLElement))throw new Error("PlotWidget requires a container element.");if(!s||typeof s.subscribe!="function")throw new Error("PlotWidget requires a bus with subscribe(cb)->unsubscribe.");if(!i||typeof i.subscribe!="function")throw new Error("PlotWidget requires a scheduler with subscribe(rate, cb)->unsubscribe.");this._scheduler=i,t.classList.add("plotStack"),this.container=t,this.axesLayer=this._createLayer("axes",1),this.traceLayer=this._createLayer("trace",2),this.overlayLayer=this._createLayer("overlay",3),this.overlayValueEl=document.createElement("span"),this.overlayValueEl.className="plotHoverOverlay",this.overlayValueEl.setAttribute("role","status"),this.overlayValueEl.setAttribute("aria-live","polite"),this.container.appendChild(this.overlayValueEl),this.valueSelector=n.valueSelector??(o=>o.floatValues[0]),this.maxPoints=n.maxPoints??1e3,this.padding=n.padding??100,this.updateRate=n.updateRate??E.Hz25,this.axesUpdateRate=n.axesUpdateRate??E.Hz5,this.traceUpdateRate=n.traceUpdateRate??this.updateRate,this.label=n.label??"",this.buf=new ee(this.maxPoints),this._unsubscribe=s.subscribe(o=>this.handle(o)),this.isTabVisible()&&this.resume(),this._boundOnResize=()=>{this.drawAxes(),this.drawTrace(),this.drawOverlay()},window.addEventListener("resize",this._boundOnResize),this._boundOnMouseMove=o=>{this._hoverXDevice=this._clientXToDeviceX(o.clientX)},this._boundOnMouseLeave=()=>{this._hoverXDevice=null},this.overlayLayer.canvas.addEventListener("mousemove",this._boundOnMouseMove),this.overlayLayer.canvas.addEventListener("mouseleave",this._boundOnMouseLeave),this.drawAxes(),this.drawTrace(),this.drawOverlay()}container;axesLayer;traceLayer;overlayLayer;overlayValueEl;valueSelector;maxPoints;padding;updateRate;axesUpdateRate;traceUpdateRate;label;buf;_unsubscribe;_scheduler;_unsubscribeAxesTick;_unsubscribeTraceTick;_bounds;_traceValues=[];_hoverXDevice=null;_boundOnResize;_boundOnMouseMove;_boundOnMouseLeave;_hasSeededInitialWindow=!1;destroy(){this._unsubscribe&&this._unsubscribe(),this._unsubscribeAxesTick&&this._unsubscribeAxesTick(),this._unsubscribeTraceTick&&this._unsubscribeTraceTick(),this._boundOnResize&&window.removeEventListener("resize",this._boundOnResize),this._boundOnMouseMove&&this.overlayLayer.canvas.removeEventListener("mousemove",this._boundOnMouseMove),this._boundOnMouseLeave&&this.overlayLayer.canvas.removeEventListener("mouseleave",this._boundOnMouseLeave),this.overlayValueEl.remove()}clear(){this.buf.clear(),this._hasSeededInitialWindow=!1,this._traceValues=[],this.drawAxes(),this.drawTrace(),this.drawOverlay()}pause(){this._unsubscribeAxesTick&&(this._unsubscribeAxesTick(),this._unsubscribeAxesTick=void 0),this._unsubscribeTraceTick&&(this._unsubscribeTraceTick(),this._unsubscribeTraceTick=void 0)}resume(){this._unsubscribeAxesTick||(this._unsubscribeAxesTick=this._scheduler.subscribe(this.axesUpdateRate,()=>this.drawAxes())),this._unsubscribeTraceTick||(this._unsubscribeTraceTick=this._scheduler.subscribe(this.traceUpdateRate,()=>{this.drawTrace(),this.drawOverlay()}))}handle(e){if(e.CommandBytes[0]!==L.REALTIME_DATA_COMMAND)return;const t=this.valueSelector(e);Number.isFinite(t)&&(this._seedInitialWindowIfNeeded(),this.buf.push(t))}_seedInitialWindowIfNeeded(){if(this._hasSeededInitialWindow||this.buf.size()>0)return;const e=Math.max(0,this.maxPoints-1);for(let t=0;t<e;t+=1)this.buf.push(0);this._hasSeededInitialWindow=!0}_resizeLayersToDisplaySize(){const e=window.devicePixelRatio||1,t=this.container.getBoundingClientRect(),s=Math.max(1,Math.floor(t.width*e)),i=Math.max(1,Math.floor(t.height*e));for(const n of[this.axesLayer,this.traceLayer,this.overlayLayer])(n.canvas.width!==s||n.canvas.height!==i)&&(n.canvas.width=s,n.canvas.height=i)}_getLayout(e,t){const a=Math.max(1,e-56-10),c=Math.max(1,t-10-24);return{left:56,right:10,top:10,bottom:24,plotW:a,plotH:c}}_computeBounds(){if(this.buf.size()===0)return null;let e=1/0,t=-1/0;this.buf.forEachInOrder(n=>{n<e&&(e=n),n>t&&(t=n)});let s=e-this.padding,i=t+this.padding;return(!Number.isFinite(s)||!Number.isFinite(i)||s===i)&&(s=-1,i=1),s>0&&(s=0),i<0&&(i=0),{yMin:s,yMax:i}}drawAxes(){this._resizeLayersToDisplaySize();const e=this.axesLayer.ctx,t=this.axesLayer.canvas.width,s=this.axesLayer.canvas.height,i=this._getThemeColors();if(e.clearRect(0,0,t,s),e.strokeStyle=i.axis,e.fillStyle=i.text,this.buf.size()===0){e.fillText("Not Connected",10,20),this._bounds=void 0;return}const n=this._computeBounds();if(!n){this._bounds=void 0;return}this._bounds=n;const{left:o,top:a,plotW:c,plotH:l}=this._getLayout(t,s);e.beginPath(),e.moveTo(o,a),e.lineTo(o,a+l),e.lineTo(o+c,a+l),e.stroke();const u=21,h=5,m=new Set;for(let d=0;d<h;d+=1){const b=Math.round(d*(u-1)/(h-1));m.add(b)}e.textAlign="right",e.textBaseline="middle";for(let d=0;d<u;d+=1){const b=d/(u-1),p=a+(1-b)*l,x=n.yMin+b*(n.yMax-n.yMin);e.beginPath(),e.moveTo(o-6,p),e.lineTo(o,p),e.stroke(),m.has(d)&&e.fillText(y(x),o-8,p)}}drawTrace(){this._resizeLayersToDisplaySize();const e=this.traceLayer.ctx,t=this.traceLayer.canvas.width,s=this.traceLayer.canvas.height,i=this._getThemeColors();if(e.clearRect(0,0,t,s),e.strokeStyle=i.trace,e.fillStyle=i.text,this.buf.size()===0){this._traceValues=[];return}const n=this._bounds??this._computeBounds();if(!n)return;const{left:o,top:a,plotW:c,plotH:l}=this._getLayout(t,s),u=this.buf.size(),h=Math.max(1,u-1),m=[],d=f=>o+f/h*c,b=f=>{const S=(f-n.yMin)/(n.yMax-n.yMin);return a+(1-S)*l};e.beginPath();let p=!0;this.buf.forEachInOrder((f,S)=>{m.push(f);const U=d(S),X=b(f);p?(e.moveTo(U,X),p=!1):e.lineTo(U,X)}),e.stroke(),this._traceValues=m;const x=this.buf.latest();if(typeof x=="number"){const f=this.label?`${this.label} `:"";e.fillText(`Current ${f}: ${y(x)}`,o+6,s-6)}}drawOverlay(){this._resizeLayersToDisplaySize();const e=this.overlayLayer.ctx,t=this.overlayLayer.canvas.width,s=this.overlayLayer.canvas.height,i=this._getThemeColors();if(e.clearRect(0,0,t,s),this._hoverXDevice===null){this.overlayValueEl.classList.remove("plotHoverOverlay--visible");return}const{left:n,top:o,plotW:a,plotH:c}=this._getLayout(t,s),l=Math.max(n,Math.min(n+a,this._hoverXDevice));if(this._traceValues.length===0){this._positionOverlayLabel(n+a/2,o+c/2,"no data");return}const u=this._bounds??this._computeBounds();if(!u){this._positionOverlayLabel(n+a/2,o+c/2,"no data");return}const h=Math.max(1,this._traceValues.length-1),m=(l-n)/a,d=Math.max(0,Math.min(this._traceValues.length-1,Math.round(m*h))),b=this._traceValues[d],p=n+d/h*a,x=(b-u.yMin)/(u.yMax-u.yMin),f=o+(1-x)*c;e.strokeStyle=i.axis,e.beginPath(),e.moveTo(p,o),e.lineTo(p,o+c),e.stroke(),e.fillStyle=i.trace,e.beginPath(),e.arc(p,f,3,0,Math.PI*2),e.fill();const S=this.label?`${this.label} `:"";this._positionOverlayLabel(p,f,`${S}${y(b)}`)}_positionOverlayLabel(e,t,s){const i=window.devicePixelRatio||1,n=e/i,o=t/i;this.overlayValueEl.textContent=s,this.overlayValueEl.style.left=`${n}px`,this.overlayValueEl.style.top=`${Math.max(4,o-10)}px`,this.overlayValueEl.classList.add("plotHoverOverlay--visible")}_clientXToDeviceX(e){const t=this.overlayLayer.canvas.getBoundingClientRect(),s=t.width>0?this.overlayLayer.canvas.width/t.width:1;return(e-t.left)*s}_createLayer(e,t){const s=document.createElement("canvas");s.className="plotLayer",s.dataset.layer=e,s.style.zIndex=String(t),this.container.appendChild(s);const i=s.getContext("2d");if(!i)throw new Error("PlotWidget requires a 2D rendering context.");return{name:e,canvas:s,ctx:i}}_getThemeColors(){const e=getComputedStyle(this.container),t=(s,i)=>e.getPropertyValue(s).trim()||i;return{text:t("--color-text","#e4edf5"),axis:t("--color-muted","#9fb1c5"),trace:t("--color-accent","#5aa4ff")}}}function Le(r){if(r.length!==64)throw new Error(`Report ${r.commandId} must be exactly 64 bytes.`);const e=[...r.fields].sort((t,s)=>t.offset-s.offset);for(const t of e){if(t.offset<4||t.offset>60)throw new Error(`Field ${t.name} in report ${r.commandId} must be in byte range [4, 60].`);if(t.offset%4!==0)throw new Error(`Field ${t.name} in report ${r.commandId} must be 4-byte aligned.`);if(t.type!=="f32"&&t.type!=="i32")throw new Error(`Field ${t.name} in report ${r.commandId} has unsupported type ${String(t.type)}.`)}for(let t=1;t<e.length;t+=1){const s=e[t-1],i=e[t],n=s.offset+4;if(i.offset<n)throw new Error(`Fields ${s.name} and ${i.name} overlap in report ${r.commandId}.`)}}function Me(r){return{name:r.name,label:r.label,offset:r.offset,type:r.type,parser:r.type==="f32"?"float":"int",readOnly:r.readOnly??!1,units:r.units??"",default:r.default,min:r.min,max:r.max,step:r.step,placeholder:r.placeholder,uiOrder:r.uiOrder,widgetMeta:r.widgetMeta}}function ze(r){return Le(r),r.fields.map(e=>Me(e)).sort((e,t)=>{const s=e.uiOrder,i=t.uiOrder;if(typeof s=="number"||typeof i=="number"){const n=typeof s=="number"?s:Number.MAX_SAFE_INTEGER,o=typeof i=="number"?i:Number.MAX_SAFE_INTEGER;if(n!==o)return n-o}return e.offset-t.offset})}function Y(r,e){return r.parser==="int"?`${Math.trunc(e)}`:`${Number(e.toPrecision(3))}`}function A(r,e){const t=typeof e.min=="number"?Y(r,e.min):"-∞",s=typeof e.max=="number"?Y(r,e.max):"+∞",i=r.parser==="int"?"integer":"float";return`${r.label} must be ${i} between ${t} and ${s}.`}class Ve extends M{txBus;panelConfig;reportSpec;fieldBindings;errorEl;receivedDataEl;_unsubscribeReport;_unsubscribeDeviceProfile;activeProfileCode=_;constructor(e,t,s,i,n,o){if(super(e),!t||typeof t.publish!="function")throw new Error("CommandPanelWidget requires a command bus with publish().");if(!s||typeof s.subscribe!="function")throw new Error("CommandPanelWidget requires a report bus with subscribe().");if(!i||typeof i.subscribe!="function")throw new Error("CommandPanelWidget requires a device profile bus with subscribe().");this.txBus=t,this.panelConfig=n,this.reportSpec=o,this.fieldBindings=[],this.errorEl=document.createElement("div"),this.errorEl.className="commandPanelError",this.errorEl.textContent="",this.receivedDataEl=document.createElement("div"),this.receivedDataEl.className="commandPanelReceived",this.receivedDataEl.textContent="Data Received:",this.render(e.bodyEl),this._unsubscribeReport=s.subscribe(a=>this.handleReport(a)),this._unsubscribeDeviceProfile=i.subscribe(a=>this.handleDeviceProfile(a))}pause(){}resume(){}destroy(){this._unsubscribeReport&&this._unsubscribeReport(),this._unsubscribeDeviceProfile&&this._unsubscribeDeviceProfile();for(const e of this.fieldBindings)this.clearTooltipTimers(e);this.fieldBindings.length=0}render(e){e.innerHTML="";const t=document.createElement("div");t.className="commandPanelFields";for(const i of ze(this.reportSpec)){const n=document.createElement("label");n.className="commandPanelRow",n.htmlFor=this.inputId(i.name);const o=document.createElement("span");o.className="commandPanelFieldLabel",o.textContent=i.label;const a=document.createElement("span");a.className="commandPanelInputWrap";const c=document.createElement("input");c.className="commandPanelInput",c.id=this.inputId(i.name),c.type="text",c.readOnly=i.readOnly,i.placeholder&&(c.placeholder=i.placeholder);const l=typeof i.default=="number"?i.default:0;c.value=i.parser==="int"?`${Math.trunc(l)}`:y(l),typeof i.step=="number"&&(c.step=`${i.step}`);const u=document.createElement("span");u.className="commandPanelUnits",u.textContent=i.units;const h=document.createElement("span");h.className="commandPanelTooltip",h.setAttribute("role","status"),h.setAttribute("aria-live","polite");const m={spec:i,input:c,tooltipEl:h,lastValidValue:c.value,constraints:j(i,this.activeProfileCode)};this.applyInputConstraints(m),c.addEventListener("keydown",d=>this.handleFieldKeydown(d,m)),c.addEventListener("blur",()=>this.enforceCommittedFieldValue(m)),c.addEventListener("mouseenter",()=>this.scheduleHoverTooltip(m)),c.addEventListener("mouseleave",()=>this.clearHoverTimer(m)),a.appendChild(c),a.appendChild(h),n.appendChild(o),n.appendChild(a),n.appendChild(u),t.appendChild(n),this.fieldBindings.push(m)}const s=document.createElement("button");s.className="commandPanelSend",s.type="button",s.textContent=this.panelConfig.buttonLabel??this.reportSpec.widgetUi?.buttonLabel??"Send",s.addEventListener("click",()=>this.handleSend()),e.appendChild(t),e.appendChild(s),e.appendChild(this.errorEl),e.appendChild(this.receivedDataEl)}handleDeviceProfile(e){this.activeProfileCode=e;for(const t of this.fieldBindings)t.constraints=j(t.spec,this.activeProfileCode),this.applyInputConstraints(t),this.enforceCommittedFieldValue(t)}applyInputConstraints(e){typeof e.constraints.min=="number"?e.input.min=`${e.constraints.min}`:e.input.removeAttribute("min"),typeof e.constraints.max=="number"?e.input.max=`${e.constraints.max}`:e.input.removeAttribute("max")}handleReport(e){if(e.CommandBytes[0]!==this.panelConfig.commandId)return;const t=new DataView(e.rawBytes.buffer,e.rawBytes.byteOffset,e.rawBytes.byteLength),s=[];for(const i of this.fieldBindings){const n=i.spec.type==="f32"?t.getFloat32(i.spec.offset,!0):t.getInt32(i.spec.offset,!0);i.input.value=i.spec.parser==="int"?`${Math.trunc(n)}`:y(n),i.lastValidValue=i.input.value;const o=i.spec.type==="f32"?n.toPrecision(3):`${n}`;s.push(o)}this.receivedDataEl.textContent=`Data Received: ${s.join(", ")}`}handleFieldKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),this.enforceCommittedFieldValue(t),t.input.blur())}enforceCommittedFieldValue(e){const t=ie({parser:e.spec.parser,constraints:e.constraints,rawText:e.input.value,formatFloat:y});if(!t.isAccepted){e.input.value=e.lastValidValue,t.shouldShowTooltip&&this.showTooltip(e,A(e.spec,e.constraints));return}e.input.value=t.normalizedValue,e.lastValidValue=t.normalizedValue,t.shouldShowTooltip&&this.showTooltip(e,A(e.spec,e.constraints))}scheduleHoverTooltip(e){this.clearHoverTimer(e),e.hoverTimerId=window.setTimeout(()=>{this.showTooltip(e,A(e.spec,e.constraints)),e.hoverTimerId=void 0},1e3)}clearHoverTimer(e){typeof e.hoverTimerId=="number"&&window.clearTimeout(e.hoverTimerId),e.hoverTimerId=void 0}showTooltip(e,t){this.clearTooltipTimers(e),e.tooltipEl.textContent=t,e.tooltipEl.classList.add("commandPanelTooltip--visible"),e.tooltipEl.classList.remove("commandPanelTooltip--fading"),e.fadeTimerId=window.setTimeout(()=>{e.tooltipEl.classList.add("commandPanelTooltip--fading")},2e3),e.hideTimerId=window.setTimeout(()=>{e.tooltipEl.classList.remove("commandPanelTooltip--visible","commandPanelTooltip--fading")},3e3)}clearTooltipTimers(e){this.clearHoverTimer(e),typeof e.fadeTimerId=="number"&&window.clearTimeout(e.fadeTimerId),typeof e.hideTimerId=="number"&&window.clearTimeout(e.hideTimerId),e.fadeTimerId=void 0,e.hideTimerId=void 0}handleSend(){this.clearError(),this.clearInputErrors();const e=new Uint8Array(64);e[0]=this.panelConfig.commandId;const t=new DataView(e.buffer);for(const s of this.fieldBindings){if(s.spec.readOnly)continue;const i=s.input.value.trim(),n=s.spec.parser==="float"?Number.parseFloat(i):Number.parseInt(i,10);if(!Number.isFinite(n)){this.setFieldError(s.input,`${s.spec.label} is not a valid number.`);return}if(s.spec.parser==="int"&&(!Number.isInteger(n)||n<te||n>se)){this.setFieldError(s.input,`${s.spec.label} must be a valid int32 value.`);return}if(typeof s.constraints.min=="number"&&n<s.constraints.min){this.setFieldError(s.input,`${s.spec.label} must be >= ${s.constraints.min}.`);return}if(typeof s.constraints.max=="number"&&n>s.constraints.max){this.setFieldError(s.input,`${s.spec.label} must be <= ${s.constraints.max}.`);return}s.spec.type==="f32"?t.setFloat32(s.spec.offset,n,!0):t.setInt32(s.spec.offset,n,!0)}this.txBus.publish({type:"hid_send",commandId:this.panelConfig.commandId,bytes:e,length:64,timestampMs:performance.now()})}inputId(e){return`cmd-${this.panelConfig.commandId}-${e}`}setFieldError(e,t){e.classList.add("commandPanelInput--error"),this.errorEl.textContent=t}clearInputErrors(){for(const e of this.fieldBindings)e.input.classList.remove("commandPanelInput--error")}clearError(){this.errorEl.textContent=""}}const V=w,B=129,Be=1,Pe=0,Re=2,Ne=120;class Ae extends M{txBus;controls;inputBindings=[];unsubscribeReportBus;sweepTimerId;sweepStartTimeMs=0;phaseRadians=0;startFrequencyHz=0;stopFrequencyHz=0;durationSeconds=0;amplitude=1;frequencySlopeHzPerSecond=0;lastTickTimestampMs=0;isLogging=!1;latestSweepValue=0;sweepLogRows=[];constructor(e,t,s){super(e),this.txBus=t,this.unsubscribeReportBus=s.subscribe(i=>this.handleInboundReport(i)),this.controls=this.render(e.bodyEl),this.syncButtonState()}pause(){}resume(){}destroy(){this.stopSweep(!0,!1),this.unsubscribeReportBus&&this.unsubscribeReportBus(),this.inputBindings.length=0}render(e){e.innerHTML="";const t=document.createElement("div");t.className="sineSweepFields";const s=this.buildInputRow(t,"Start Frequency","1"),i=this.buildInputRow(t,"Stop Frequency","5"),n=this.buildInputRow(t,"Duration (seconds)","4"),o=this.buildInputRow(t,"Amplitude","1");this.inputBindings=[this.createInputBinding("Start Frequency",s),this.createInputBinding("Stop Frequency",i),this.createInputBinding("Duration (seconds)",n,0,Ne,!0),this.createInputBinding("Amplitude",o)];const a=document.createElement("div");a.className="sineSweepButtons";const c=document.createElement("button");c.type="button",c.textContent="Start",c.addEventListener("click",()=>this.startSweep());const l=document.createElement("button");l.type="button",l.textContent="Stop",l.addEventListener("click",()=>this.stopSweep(!0,!0)),a.append(c,l);const u=document.createElement("div");u.className="sineSweepCurrentFrequency";const h=document.createElement("span");h.textContent="Current Frequency:";const m=document.createElement("span");m.textContent="-",u.append(h,m);const d=document.createElement("div");return d.className="commandPanelError",t.append(a,u,d),e.append(t),{startFrequencyInput:s,stopFrequencyInput:i,durationInput:n,amplitudeInput:o,startButton:c,stopButton:l,currentFrequencyValue:m,errorEl:d}}buildInputRow(e,t,s){const i=document.createElement("label");i.className="commandPanelRow";const n=document.createElement("span");n.className="commandPanelFieldLabel",n.textContent=t;const o=document.createElement("span");o.className="commandPanelInputWrap";const a=document.createElement("input");return a.className="commandPanelInput",a.type="text",a.value=s,o.append(a),i.append(n,o),e.append(i),a}createInputBinding(e,t,s,i,n=!1){const o={label:e,input:t,lastValidValue:t.value,min:s,max:i,revertOnClip:n};return t.addEventListener("keydown",a=>this.handleInputKeydown(a,o)),t.addEventListener("blur",()=>this.enforceCommittedInput(o)),o}handleInputKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),this.enforceCommittedInput(t),t.input.blur())}enforceCommittedInput(e){const t=ie({parser:"float",constraints:{min:e.min,max:e.max},rawText:e.input.value,formatFloat:y});if(!t.isAccepted||e.revertOnClip&&t.wasClipped){if(e.input.value=e.lastValidValue,typeof e.max=="number"&&t.wasClipped&&e.revertOnClip)this.controls.errorEl.textContent=`${e.label} must be <= ${e.max}.`;else{const s=typeof e.min=="number"?` >= ${e.min}`:"",i=typeof e.max=="number"?`${s?" and":""} <= ${e.max}`:"";this.controls.errorEl.textContent=`${e.label} must be a float${s}${i}.`}return}e.input.value=t.normalizedValue,e.lastValidValue=t.normalizedValue,this.controls.errorEl.textContent=""}readSweepParameters(){for(const e of this.inputBindings)this.enforceCommittedInput(e);return{startFrequencyHz:Number.parseFloat(this.controls.startFrequencyInput.value.trim()),stopFrequencyHz:Number.parseFloat(this.controls.stopFrequencyInput.value.trim()),durationSeconds:Number.parseFloat(this.controls.durationInput.value.trim()),amplitude:Number.parseFloat(this.controls.amplitudeInput.value.trim())}}startSweep(){if(this.sweepTimerId!==void 0)return;const e=this.readSweepParameters();this.startFrequencyHz=e.startFrequencyHz,this.stopFrequencyHz=e.stopFrequencyHz,this.durationSeconds=e.durationSeconds,this.amplitude=e.amplitude,this.frequencySlopeHzPerSecond=(this.stopFrequencyHz-this.startFrequencyHz)/this.durationSeconds,this.sweepStartTimeMs=performance.now(),this.lastTickTimestampMs=this.sweepStartTimeMs,this.phaseRadians=0,this.sweepLogRows=[],this.latestSweepValue=0,this.isLogging=!0,this.controls.currentFrequencyValue.textContent=`${y(this.startFrequencyHz)} Hz`,this.publishSweepReport(0),this.sweepTimerId=window.setInterval(()=>this.handleSweepTick(),Re),this.syncButtonState()}handleSweepTick(){const e=performance.now(),t=(e-this.sweepStartTimeMs)/1e3;if(t>=this.durationSeconds){this.stopSweep(!0,!0);return}const s=this.startFrequencyHz+this.frequencySlopeHzPerSecond*t,i=(e-this.lastTickTimestampMs)/1e3;this.lastTickTimestampMs=e,this.phaseRadians+=2*Math.PI*s*i;const n=this.amplitude*Math.sin(this.phaseRadians);this.controls.currentFrequencyValue.textContent=`${y(s)} Hz`,this.publishSweepReport(n)}stopSweep(e,t){if(this.sweepTimerId!==void 0&&(window.clearInterval(this.sweepTimerId),this.sweepTimerId=void 0),this.isLogging=!1,e){const s=new Uint8Array(V);s[0]=B,s[1]=Pe,this.txBus.publish({type:"hid_send",commandId:B,bytes:s,length:V,timestampMs:performance.now()})}t&&this.downloadSweepCsv(),this.controls.currentFrequencyValue.textContent="-",this.syncButtonState()}publishSweepReport(e){const t=new Uint8Array(V);t[0]=B,t[1]=Be,new DataView(t.buffer).setFloat32(4,e,!0),this.latestSweepValue=e,this.txBus.publish({type:"hid_send",commandId:B,bytes:t,length:V,timestampMs:performance.now()})}syncButtonState(){const e=this.sweepTimerId!==void 0;this.controls.startButton.disabled=e,this.controls.stopButton.disabled=!e}handleInboundReport(e){this.isLogging&&e.CommandBytes[0]===L.REALTIME_DATA_COMMAND&&this.sweepLogRows.push({i7:e.intValues[6]??0,f1:e.floatValues[0]??Number.NaN,sweepValue:this.latestSweepValue})}downloadSweepCsv(){const e="i7,f1,currentSweepValue",t=this.sweepLogRows.map(a=>[a.i7,a.f1,a.sweepValue].join(",")),s=[e,...t].join(`
`),i=new Blob([s],{type:"text/csv;charset=utf-8"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=`sinesweep_${this.getTimestampForFilename()}.csv`,o.click(),URL.revokeObjectURL(n)}getTimestampForFilename(){const e=new Date,t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${t}_${s}_${i}_${n}_${o}`}}const ne=document.getElementById("dashboard"),Oe=1e4;if(!ne)throw new Error("Missing required UI elements.");const Fe=ne,P=new URLSearchParams(window.location.search).get("sim")==="1",He=()=>{const r=document.createElement("div");r.className="topbar dashboardControls";const e=document.createElement("div");e.className="topbarLeft";const t=document.createElement("div");t.className="topbarCenter";const s=document.createElement("div");s.className="topbarRight";const i=document.createElement("button");i.id="connectBtn",i.textContent="Connect";const n=document.createElement("div");n.className="topbarGroup",n.append(i);const o=document.createElement("div");o.id="status",o.className="status",o.textContent="Disconnected";const a=document.createElement("button");a.id="simulateBtn",a.textContent=P?"Exit Sim":"Simulate",a.addEventListener("click",()=>{const l=new URL(window.location.href);P?l.searchParams.delete("sim"):l.searchParams.set("sim","1"),window.location.href=l.toString()});const c=document.createElement("a");return c.className="topbarLink",c.href=new URL("one-pager/",window.location.href).toString(),c.textContent="Chiralight Advantage",c.target="_blank",c.rel="noreferrer",c.title="Opens in New Tab",n.append(o,a),e.append(n),t.append(c),r.append(e,t,s),{headerEl:r,connectBtn:i,statusEl:o,rightSlotEl:s}},{headerEl:De,connectBtn:ke,statusEl:$e}=He(),z=document.createElement("nav");z.id="tabs";z.className="tabs";z.setAttribute("aria-label","Dashboard tabs");const W=document.createElement("div");W.className="dashboardPanels";Fe.append(De,z,W);const re=ke,R=$e,K=z,J=W,g=new le,N=new ue,O=new he,oe=new fe,C=P?new ve({bus:g,commandBus:N}):new we({bus:g,commandBus:N,deviceProfileBus:oe}),ae=[{id:"realtime",label:"Realtime Data"},{id:"configuration",label:"Configuration"},{id:"control",label:"Control"}],qe=[{pos:20,title:"Motor Speed (rad/s)",hint:"Motor Speed in radians per second",minimizedTextContent:"Mtr Spd",floatIndex:0,padding:100,label:"Motor Speed"},{pos:30,title:"Motor Current (A)",hint:"Motor Current in Amperes",minimizedTextContent:"Mtr Cur",floatIndex:1,padding:1,label:"Motor Current"},{pos:40,title:"Battery Voltage (V)",hint:"DC Link Voltage in Volts",minimizedTextContent:"Bat Vlt",floatIndex:2,padding:10,label:"Battery Voltage"},{pos:50,title:"Battery Current (A)",hint:"DC Link Current in Ampere",minimizedTextContent:"Bat Cur",floatIndex:3,padding:1,label:"Battery Current"},{pos:60,title:"MOSFET Temp (°C)",hint:"MOSFET Temperature in °C",minimizedTextContent:"Temp",floatIndex:9,padding:1,label:"MOSFET Temp"}],We=()=>qe.map(r=>({tab:"realtime",pos:r.pos,kind:"plot",title:r.title,hint:r.hint,minimizedTextContent:r.minimizedTextContent,size:{w:520,h:320},plot:{valueSelector:e=>e.floatValues[r.floatIndex],maxPoints:Oe,padding:r.padding,traceUpdateRate:E.Hz25,axesUpdateRate:E.Hz10,label:r.label}})),Ue=[...We(),{tab:"realtime",pos:100,kind:"export",title:"Export CSV",hint:"Lossless log from 64-byte reports",minimizedTextContent:"CSV",size:{w:420,h:200}},{tab:"configuration",pos:20,kind:"command",title:"Automatic Characterization",hint:"ReportSpec command 2",minimizedTextContent:"Auto Char",size:{w:520,h:340},command:{commandId:2}},{tab:"configuration",pos:30,kind:"command",title:"Power Configuration",hint:"ReportSpec command 4",minimizedTextContent:"Power Cfg",size:{w:520,h:340},command:{commandId:4}},{tab:"control",pos:20,kind:"sineSweep",title:"Sine Sweep",hint:"Command 129 sine sweep control",minimizedTextContent:"Sweep",size:{w:520,h:320}}],D=[],k=new Map;let I=ae[0].id;function Xe(){J.innerHTML="",D.length=0,k.clear();const r=[...Ue].sort((e,t)=>e.pos-t.pos);for(const e of r){const{panel:t,body:s,titleEl:i}=Ee(e),n={panelEl:t,bodyEl:s,titleEl:i,title:e.title,minimizedTextContent:e.minimizedTextContent??"",initialTabVisible:e.tab===I};let o=null;if(e.kind==="log"){const a=document.createElement("textarea");a.className="log",a.placeholder="Reports...",a.readOnly=!0,s.appendChild(a),o=new ge(n,a,g,O,e.log)}else if(e.kind==="plot"){const a=document.createElement("div");a.className="plotStack",s.appendChild(a),o=new Ie(n,a,g,O,e.plot)}else if(e.kind==="export"){const a=document.createElement("div");s.appendChild(a),o=new Te(n,a,g,O)}else if(e.kind==="command"){const a=_e[e.command.commandId];if(!a)throw new Error(`Missing report spec for commandId ${e.command.commandId}.`);if(a.widgetUi?.instantiateGenericCommandWidget===!1)continue;o=new Ve(n,N,g,oe,e.command,a)}else e.kind==="sineSweep"&&(o=new Ae(n,N,g));J.appendChild(t),o&&(D.push(o),k.set(o,e.tab))}}Xe();ce();function ce(){K.innerHTML="";for(const r of ae){const e=document.createElement("button");e.type="button",e.className="tabButton",e.textContent=r.label,e.dataset.tabId=r.id;const t=r.id===I;e.classList.toggle("tabButton--active",t),e.setAttribute("aria-selected",String(t)),e.setAttribute("role","tab"),e.addEventListener("click",()=>Ge(r.id)),K.appendChild(e)}}function Ge(r){if(I!==r){I=r;for(const e of D){const t=k.get(e);t&&e.setTabVisible(t===I)}ce()}}C.onStatus(r=>{R.textContent=r,re.textContent=C.isConnected()?"Disconnect":"Connect"});re.addEventListener("click",async()=>{if(!C.isSupported()){R.textContent="WebHID not supported in this browser.";return}try{C.isConnected()?await C.disconnect():await C.connect()}catch(r){R.textContent=`Error: ${r instanceof Error?r.message:String(r)}`}});P&&C.connect().catch(r=>{R.textContent=`Error: ${r instanceof Error?r.message:String(r)}`});
